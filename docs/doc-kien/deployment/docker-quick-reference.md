# Docker Deployment - Quick Reference Guide

**Version**: 1.0
**Last Updated**: 2026-02-06

---

## üöÄ Quick Start (3 Commands)

```bash
# 1. Configure instance (interactive mode)
./docker/scripts/setup-instance.sh --interactive

# 2. Deploy everything
./docker/scripts/deploy.sh
# Select option 1: Complete fresh deployment

# 3. Access the app
# Local: http://localhost:3025/setup
# Production: https://yourdomain.com/setup
```

---

## üìã Common Commands

### Deployment

```bash
# Full deployment (from scratch)
./docker/scripts/deploy.sh                    # Interactive menu
# Option 1: Complete fresh deployment

# Rebuild app only (after code changes)
docker compose build app
docker compose up -d app

# Restart all services
docker compose restart

# Stop all services
docker compose down

# Stop and remove all data (‚ö†Ô∏è DESTRUCTIVE)
docker compose down -v
```

### Logs

```bash
# View all logs
docker compose logs -f

# View specific service
docker compose logs -f app
docker compose logs -f db
docker compose logs -f kong

# View last 100 lines
docker compose logs --tail=100 app

# Follow logs with timestamps
docker compose logs -f --timestamps app
```

### Database Operations

```bash
# Apply schema
./docker/scripts/apply-schema.sh

# Connect to database
docker compose exec db psql -U postgres

# Backup database
docker compose exec -T db pg_dump -U postgres postgres > backup_$(date +%Y%m%d_%H%M%S).sql

# Restore database
cat backup.sql | docker compose exec -T db psql -U postgres

# View database size
docker compose exec db psql -U postgres -c "SELECT pg_size_pretty(pg_database_size('postgres'));"
```

### Container Management

```bash
# List running containers
docker compose ps

# View resource usage
docker compose stats

# Restart specific service
docker compose restart app

# View service configuration
docker compose config

# Validate compose file
docker compose config --quiet
```

### Backup & Restore

```bash
# Manual backup (DB + uploads + .env)
./docker/scripts/backup.sh

# Restore from backup
cd backups/backup_YYYYMMDD_HHMMSS/
cat database.sql | docker compose exec -T db psql -U postgres
cp -r uploads/* ../../uploads/
cp .env.backup ../../.env
```

---

## üîß Configuration Files

| File | Purpose | Location |
|------|---------|----------|
| `.env` | Environment variables | Root (generated) |
| `docker-compose.yml` | Services definition | Root |
| `Dockerfile` | App image build | Root |
| `next.config.ts` | Next.js configuration | Root |
| `supabase/config.toml` | Supabase CLI config | supabase/ |
| `volumes/api/kong.yml` | Kong API Gateway routes | volumes/api/ (generated) |
| `volumes/logs/vector.yml` | Logging configuration | volumes/logs/ (generated) |

---

## üåê Access URLs

### Local Mode (DEPLOYMENT_MODE=local)
```
Application:       http://localhost:3025
API Gateway:       http://localhost:8000
Supabase Studio:   http://localhost:3000
Setup Page:        http://localhost:3025/setup
```

### Production Mode (v·ªõi Cloudflare Tunnel)
```
Application:       https://service.example.com
API Gateway:       https://api.example.com
Supabase Studio:   https://studio.example.com
Setup Page:        https://service.example.com/setup
```

---

## üîê Important Credentials

**Location**: `INSTANCE_INFO.txt` (generated by setup script)

```bash
# View credentials
cat INSTANCE_INFO.txt

# Environment variables
cat .env | grep -E "(PASSWORD|KEY|SECRET)"
```

**Default Credentials** (change after first setup):
- Setup Password: (generated in INSTANCE_INFO.txt)
- Admin Email: admin@example.com (configure in setup script)
- Admin Password: (configure in setup script)
- Studio Dashboard: supabase / (generated in .env)

---

## üêõ Troubleshooting

### Services Won't Start

```bash
# Check service status
docker compose ps

# View logs for failed service
docker compose logs <service-name>

# Check disk space
df -h

# Check memory
free -h

# Restart specific service
docker compose restart <service-name>
```

### Database Connection Issues

```bash
# Check DB is running
docker compose ps db

# Check DB health
docker compose exec db pg_isready -U postgres

# View DB logs
docker compose logs db

# Restart DB (‚ö†Ô∏è causes brief downtime)
docker compose restart db
```

### App Not Responding

```bash
# Check app logs
docker compose logs -f app

# Check app health
curl http://localhost:3025/api/health

# Restart app
docker compose restart app

# Rebuild if code changed
docker compose build app
docker compose up -d app
```

### Port Already in Use

```bash
# Find process using port 3025
sudo lsof -i :3025

# Kill process (or change APP_PORT in .env)
sudo kill -9 <PID>

# Restart services
docker compose down
docker compose up -d
```

### Out of Disk Space

```bash
# Check disk usage
df -h

# Clean Docker
docker system prune -a --volumes

# Clean old images
docker image prune -a

# Remove unused volumes
docker volume prune
```

### Reset Everything (‚ö†Ô∏è DESTRUCTIVE)

```bash
# Stop all services
docker compose down -v

# Remove generated files
rm -rf volumes/ .env INSTANCE_INFO.txt

# Clean Docker system
docker system prune -a --volumes

# Start fresh
./docker/scripts/deploy.sh
# Option 1: Complete fresh deployment
```

---

## üìä Health Checks

### Manual Health Checks

```bash
# Check all services
docker compose ps

# Check app health endpoint
curl http://localhost:3025/api/health

# Check Kong
curl http://localhost:8000/

# Check database
docker compose exec db pg_isready -U postgres

# Check disk space
df -h

# Check memory
free -h

# Check logs for errors
docker compose logs --tail=50 | grep -i error
```

### Service Health Status

```bash
# View health status of all services
docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Health}}"

# Watch health status (updates every 2 seconds)
watch -n 2 'docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Health}}"'
```

---

## üîÑ Updates & Maintenance

### Update Application Code

```bash
# Pull latest code
git pull

# Rebuild and restart app
docker compose build app
docker compose up -d app

# View logs to verify
docker compose logs -f app
```

### Update Docker Images

```bash
# Pull latest images
docker compose pull

# Recreate containers with new images
docker compose up -d --force-recreate

# Remove old images
docker image prune -a
```

### Update Database Schema

```bash
# Apply new schema changes
./docker/scripts/apply-schema.sh

# Or manually
docker compose exec db psql -U postgres < new_schema.sql
```

### Rotate Secrets

```bash
# 1. Generate new secrets
openssl rand -hex 32

# 2. Update .env file
nano .env

# 3. Regenerate API keys if JWT_SECRET changed
node docker/scripts/generate-keys.js "$(grep ^JWT_SECRET .env | cut -d '=' -f2)"

# 4. Rebuild app (for NEXT_PUBLIC_* vars)
docker compose build app

# 5. Restart all services
docker compose down
docker compose up -d
```

---

## üìà Performance Monitoring

### Resource Usage

```bash
# View real-time stats
docker compose stats

# View stats without streaming
docker compose stats --no-stream

# View specific service
docker compose stats app

# Export stats to file
docker compose stats --no-stream > stats_$(date +%Y%m%d_%H%M%S).txt
```

### Database Performance

```bash
# Connect to DB
docker compose exec db psql -U postgres

# View active connections
SELECT count(*) FROM pg_stat_activity;

# View slow queries
SELECT pid, now() - pg_stat_activity.query_start AS duration, query
FROM pg_stat_activity
WHERE state = 'active' AND now() - pg_stat_activity.query_start > interval '5 seconds';

# View database size
SELECT pg_size_pretty(pg_database_size('postgres'));

# View table sizes
SELECT schemaname, tablename,
       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 10;
```

---

## üîó Useful Links

### Documentation
- **Full Deployment Plan**: `docs/doc-kien/docker-deployment-plan.md`
- **Docker README**: `docker/README.md`
- **Project Guide**: `CLAUDE.md`
- **Schema Files**: `docs/data/schemas/`

### Scripts Location
- `docker/scripts/setup-instance.sh` - Instance setup
- `docker/scripts/deploy.sh` - Deployment automation
- `docker/scripts/apply-schema.sh` - Schema deployment
- `docker/scripts/backup.sh` - Backup automation
- `docker/scripts/generate-keys.js` - Key generation

### External Resources
- [Docker Compose Docs](https://docs.docker.com/compose/)
- [Supabase Self-Hosting](https://supabase.com/docs/guides/self-hosting)
- [Next.js Docker](https://nextjs.org/docs/deployment#docker-image)
- [PostgreSQL Docker](https://hub.docker.com/_/postgres)

---

## üí° Tips & Best Practices

### Development
- ‚úÖ Use local mode for quick testing
- ‚úÖ Keep `.env` file secure (never commit)
- ‚úÖ Regularly backup database during development
- ‚úÖ Use `docker compose logs -f` ƒë·ªÉ monitor issues

### Production
- ‚úÖ Always test deployment on staging first
- ‚úÖ Setup automated backups (cron job)
- ‚úÖ Monitor disk space and memory
- ‚úÖ Keep Docker images updated
- ‚úÖ Use strong passwords (generated by setup script)
- ‚úÖ Setup Cloudflare Tunnel for secure access
- ‚úÖ Enable monitoring and alerting
- ‚úÖ Document custom configurations

### Maintenance
- ‚úÖ Regular backups (daily recommended)
- ‚úÖ Monitor logs for errors
- ‚úÖ Clean old Docker images weekly
- ‚úÖ Update secrets periodically
- ‚úÖ Test disaster recovery procedures
- ‚úÖ Keep documentation up to date

---

## üÜò Getting Help

### Check Logs First
```bash
# View all logs
docker compose logs -f

# Search for errors
docker compose logs | grep -i error

# View specific service
docker compose logs -f <service-name>
```

### Common Issues Solutions
1. **Port conflicts** ‚Üí Change APP_PORT in setup script
2. **Out of disk space** ‚Üí Run `docker system prune -a`
3. **Services won't start** ‚Üí Check `docker compose logs`
4. **DB connection failed** ‚Üí Verify DB is healthy
5. **App build failed** ‚Üí Check Dockerfile and node_modules

### Contact
- Check `docker/README.md` for detailed troubleshooting
- Review `docs/doc-kien/docker-deployment-plan.md`
- Open issue in project repository

---

## ‚ö° Quick Scenarios

### Scenario 1: Fresh Installation
```bash
./docker/scripts/setup-instance.sh --interactive
./docker/scripts/deploy.sh  # Option 1
# Access http://localhost:3025/setup
```

### Scenario 2: Code Update
```bash
git pull
docker compose build app
docker compose up -d app
docker compose logs -f app
```

### Scenario 3: Database Issue
```bash
docker compose logs db
docker compose restart db
docker compose exec db psql -U postgres
```

### Scenario 4: Full Reset
```bash
docker compose down -v
rm -rf volumes/ .env INSTANCE_INFO.txt
./docker/scripts/deploy.sh  # Option 1
```

### Scenario 5: Backup Before Major Change
```bash
./docker/scripts/backup.sh
# Make changes
# If issue: restore from backups/ directory
```

---

**Last Updated**: 2026-02-06 | **Version**: 1.0
