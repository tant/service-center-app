# Thiáº¿t Káº¿ Kiá»ƒm Thá»­ Giai Äoáº¡n 2 - Trung TÃ¢m Dá»‹ch Vá»¥

**PhiÃªn Báº£n:** 1.0
**NgÃ y Táº¡o:** 2025-10-25
**Giai Äoáº¡n:** Phase 2 - Workflow, Warranty & Warehouse
**Stories:** 1.1 - 1.17

---

## Má»¥c Lá»¥c

1. [Giá»›i Thiá»‡u](#giá»›i-thiá»‡u)
2. [PhÆ°Æ¡ng PhÃ¡p Kiá»ƒm Thá»­](#phÆ°Æ¡ng-phÃ¡p-kiá»ƒm-thá»­)
3. [Dá»¯ Liá»‡u Kiá»ƒm Thá»­](#dá»¯-liá»‡u-kiá»ƒm-thá»­)
4. [Thiáº¿t Káº¿ Kiá»ƒm Thá»­ Theo Story](#thiáº¿t-káº¿-kiá»ƒm-thá»­-theo-story)
   - [Phase 1: Foundation (1.1-1.3)](#phase-1-foundation)
   - [Phase 2: Core Workflow (1.4-1.5)](#phase-2-core-workflow)
   - [Phase 3: Warehouse Foundation (1.6-1.7)](#phase-3-warehouse-foundation)
   - [Phase 4: Warehouse Operations (1.8-1.10)](#phase-4-warehouse-operations)
   - [Phase 5: Public Portal (1.11-1.14)](#phase-5-public-portal)
   - [Phase 6: Enhanced Features (1.15-1.17)](#phase-6-enhanced-features)
5. [Ma Tráº­n Truy Xuáº¥t](#ma-tráº­n-truy-xuáº¥t)

---

## Giá»›i Thiá»‡u

TÃ i liá»‡u nÃ y mÃ´ táº£ chi tiáº¿t thiáº¿t káº¿ kiá»ƒm thá»­ cho táº¥t cáº£ cÃ¡c stories trong Giai Äoáº¡n 2 cá»§a há»‡ thá»‘ng Trung TÃ¢m Dá»‹ch Vá»¥. Má»—i story Ä‘Æ°á»£c thiáº¿t káº¿ kiá»ƒm thá»­ theo phÆ°Æ¡ng phÃ¡p Given-When-Then Ä‘á»ƒ Ä‘áº£m báº£o:

- **Truy xuáº¥t yÃªu cáº§u Ä‘áº§y Ä‘á»§** - Ãnh xáº¡ tá»«ng test case Ä‘áº¿n acceptance criteria
- **TÃ­nh nháº¥t quÃ¡n** - Sá»­ dá»¥ng cÃ¹ng thuáº­t ngá»¯ vÃ  cáº¥u trÃºc
- **Kháº£ nÄƒng tá»± Ä‘á»™ng hÃ³a** - Ká»‹ch báº£n rÃµ rÃ ng, dá»… chuyá»ƒn thÃ nh test scripts
- **Äá»™ bao phá»§ toÃ n diá»‡n** - Kiá»ƒm thá»­ chá»©c nÄƒng, báº£o máº­t, hiá»‡u suáº¥t, tÃ­ch há»£p

---

## PhÆ°Æ¡ng PhÃ¡p Kiá»ƒm Thá»­

### Máº«u Given-When-Then

Táº¥t cáº£ test case Ä‘Æ°á»£c viáº¿t theo Ä‘á»‹nh dáº¡ng:

```
**Given** (Äiá»u kiá»‡n ban Ä‘áº§u)
  - Tráº¡ng thÃ¡i há»‡ thá»‘ng
  - Dá»¯ liá»‡u cÃ³ sáºµn
  - Quyá»n ngÆ°á»i dÃ¹ng

**When** (HÃ nh Ä‘á»™ng)
  - CÃ¡c bÆ°á»›c thá»±c hiá»‡n
  - TÆ°Æ¡ng tÃ¡c vá»›i há»‡ thá»‘ng

**Then** (Káº¿t quáº£ mong Ä‘á»£i)
  - Thay Ä‘á»•i dá»¯ liá»‡u
  - Pháº£n há»“i UI
  - ThÃ´ng bÃ¡o
  - Logs/audit trail
```

### PhÃ¢n Loáº¡i Kiá»ƒm Thá»­

- **[FUNC]** - Functional Testing (Kiá»ƒm thá»­ chá»©c nÄƒng)
- **[SEC]** - Security Testing (Kiá»ƒm thá»­ báº£o máº­t)
- **[PERF]** - Performance Testing (Kiá»ƒm thá»­ hiá»‡u suáº¥t)
- **[INT]** - Integration Testing (Kiá»ƒm thá»­ tÃ­ch há»£p)
- **[E2E]** - End-to-End Testing (Kiá»ƒm thá»­ Ä‘áº§u cuá»‘i)

---

## Dá»¯ Liá»‡u Kiá»ƒm Thá»­

### NgÆ°á»i DÃ¹ng Kiá»ƒm Thá»­

| Vai TrÃ² | Email | TÃªn | Máº­t Kháº©u |
|---------|-------|-----|----------|
| Quáº£n Trá»‹ ViÃªn | admin@test.com | Admin Test | test_admin_123 |
| Quáº£n LÃ½ | manager@test.com | Manager Test | test_manager_123 |
| Ká»¹ Thuáº­t ViÃªn 1 | tech1@test.com | Ká»¹ Thuáº­t ViÃªn 1 | test_tech1_123 |
| Ká»¹ Thuáº­t ViÃªn 2 | tech2@test.com | Ká»¹ Thuáº­t ViÃªn 2 | test_tech2_123 |
| Lá»… TÃ¢n | reception@test.com | Lá»… TÃ¢n Test | test_reception_123 |

### KhÃ¡ch HÃ ng Kiá»ƒm Thá»­

| TÃªn | Äiá»‡n Thoáº¡i | Email |
|-----|-----------|-------|
| Nguyá»…n VÄƒn A | 0901234567 | nguyenvana@example.com |
| Tráº§n Thá»‹ B | 0912345678 | tranthib@example.com |
| LÃª VÄƒn C | 0923456789 | levanc@example.com |

### Sáº£n Pháº©m Kiá»ƒm Thá»­

| TÃªn | ThÆ°Æ¡ng Hiá»‡u | Loáº¡i | SKU | Serial Number |
|-----|-------------|------|-----|---------------|
| iPhone 13 Pro | Apple | Smartphone | IP13P-128-BLU | SN-IP13P-001 |
| Samsung Galaxy S23 | Samsung | Smartphone | SGS23-256-BLK | SN-SGS23-001 |
| MacBook Air M2 | Apple | Laptop | MBA-M2-512-SLV | SN-MBA-001 |

### Loáº¡i CÃ´ng Viá»‡c Kiá»ƒm Thá»­

| Danh Má»¥c | TÃªn | MÃ´ Táº£ | Thá»i Gian Æ¯á»›c TÃ­nh |
|----------|-----|-------|-------------------|
| Intake | Tiáº¿p nháº­n mÃ¡y | Kiá»ƒm tra ngoáº¡i quan, phá»¥ kiá»‡n | 15 phÃºt |
| Diagnosis | Cháº©n Ä‘oÃ¡n sá»± cá»‘ | XÃ¡c Ä‘á»‹nh nguyÃªn nhÃ¢n hÆ° há»ng | 30 phÃºt |
| Repair | Thay mÃ n hÃ¬nh | Thay tháº¿ mÃ n hÃ¬nh hÆ° | 60 phÃºt |
| QA | Kiá»ƒm tra cháº¥t lÆ°á»£ng | Kiá»ƒm tra sau sá»­a chá»¯a | 20 phÃºt |
| Closing | ÄÃ³ng gÃ³i giao hÃ ng | Chuáº©n bá»‹ giao hÃ ng cho khÃ¡ch | 10 phÃºt |

---

## Thiáº¿t Káº¿ Kiá»ƒm Thá»­ Theo Story

## Phase 1: Foundation

### Story 1.1: Foundation Setup

**Má»¥c tiÃªu:** XÃ¡c minh cÆ¡ sá»Ÿ háº¡ táº§ng database vÃ  frontend Ä‘Æ°á»£c thiáº¿t láº­p Ä‘Ãºng

#### TC-1.1.1: Kiá»ƒm Tra Database Tables [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Structure Validation

**Given:**
- Supabase Ä‘ang cháº¡y trÃªn local
- Migrations Ä‘Ã£ Ä‘Æ°á»£c apply

**When:**
- Truy váº¥n danh sÃ¡ch tables trong database

**Then:**
- 14 báº£ng Phase 2 tá»“n táº¡i:
  - `task_templates`, `task_types`, `task_templates_tasks`
  - `service_ticket_tasks`, `task_history`, `ticket_template_changes`
  - `physical_warehouses`, `virtual_warehouses`, `physical_products`
  - `stock_movements`, `product_stock_thresholds`
  - `rma_batches`, `service_requests`, `email_notifications`

**SQL Kiá»ƒm Tra:**
```sql
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name IN (
  'task_templates', 'task_types', 'service_ticket_tasks',
  'physical_warehouses', 'virtual_warehouses', 'rma_batches'
)
ORDER BY table_name;
```

---

#### TC-1.1.2: Kiá»ƒm Tra ENUMs [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Data Type Validation

**Given:**
- Database Ä‘Ã£ Ä‘Æ°á»£c migrate

**When:**
- Truy váº¥n cÃ¡c ENUM types

**Then:**
- CÃ¡c ENUM sau tá»“n táº¡i vá»›i giÃ¡ trá»‹ Ä‘Ãºng:
  - `task_status`: pending, in_progress, completed, blocked, skipped
  - `warehouse_type`: main, warranty_stock, rma_staging, dead_stock, in_service, parts

**SQL Kiá»ƒm Tra:**
```sql
SELECT t.typname, e.enumlabel
FROM pg_type t
JOIN pg_enum e ON t.oid = e.enumtypid
WHERE t.typname IN ('task_status', 'warehouse_type')
ORDER BY t.typname, e.enumsortorder;
```

---

#### TC-1.1.3: Kiá»ƒm Tra RLS Policies [SEC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Security

**Given:**
- Database Ä‘Ã£ Ä‘Æ°á»£c thiáº¿t láº­p
- RLS Ä‘Ã£ Ä‘Æ°á»£c enable

**When:**
- Truy váº¥n policies cho tá»«ng báº£ng Phase 2

**Then:**
- Má»—i báº£ng cÃ³ Ã­t nháº¥t 4 policies (SELECT, INSERT, UPDATE, DELETE)
- Policies phÃ¢n quyá»n theo role:
  - Admin: Full access
  - Manager: Read + limited write
  - Technician: Task-specific access
  - Reception: Request management

**SQL Kiá»ƒm Tra:**
```sql
SELECT schemaname, tablename, policyname, roles, cmd
FROM pg_policies
WHERE tablename IN ('task_templates', 'service_ticket_tasks')
ORDER BY tablename, cmd;
```

---

#### TC-1.1.4: Kiá»ƒm Tra tRPC Routers [INT]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** API Integration

**Given:**
- Next.js dev server Ä‘ang cháº¡y
- tRPC routers Ä‘Ã£ Ä‘Æ°á»£c Ä‘Äƒng kÃ½

**When:**
- Gá»i health check endpoint
- Kiá»ƒm tra router registration

**Then:**
- 7 routers Phase 2 kháº£ dá»¥ng:
  - workflow, warehouse, inventory
  - serviceRequest, notifications
  - tickets, customers

**CÃ¡ch Kiá»ƒm Tra:**
```bash
curl http://localhost:3025/api/health
# Response: { "status": "healthy" }
```

---

### Story 1.2: Task Template Management

**Má»¥c tiÃªu:** Quáº£n lÃ½ máº«u cÃ´ng viá»‡c vá»›i kháº£ nÄƒng CRUD Ä‘áº§y Ä‘á»§

#### TC-1.2.1: Táº¡o Máº«u CÃ´ng Viá»‡c Má»›i [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Create Operation

**Given:**
- ÄÄƒng nháº­p vá»›i vai trÃ² Quáº£n Trá»‹ ViÃªn
- Äang á»Ÿ trang /workflows/templates
- CÃ³ sáºµn 15 loáº¡i cÃ´ng viá»‡c trong database

**When:**
1. Nháº¥p nÃºt "Máº«u Má»›i"
2. Äiá»n thÃ´ng tin:
   - TÃªn: "Sá»­a Chá»¯a MÃ n HÃ¬nh iPhone"
   - MÃ´ táº£: "Quy trÃ¬nh thay mÃ n hÃ¬nh cho iPhone"
   - Loáº¡i dá»‹ch vá»¥: "Tráº£ phÃ­" (paid)
   - Thá»±c thi trÃ¬nh tá»±: Báº­t (strict_sequence: true)
3. ThÃªm 5 cÃ´ng viá»‡c:
   - Tiáº¿p nháº­n mÃ¡y (Intake, báº¯t buá»™c)
   - Cháº©n Ä‘oÃ¡n (Diagnosis, báº¯t buá»™c)
   - Thay mÃ n hÃ¬nh (Repair, báº¯t buá»™c)
   - Kiá»ƒm tra cháº¥t lÆ°á»£ng (QA, báº¯t buá»™c)
   - ÄÃ³ng gÃ³i giao hÃ ng (Closing, tÃ¹y chá»n)
4. KÃ©o tháº£ Ä‘á»ƒ sáº¯p xáº¿p thá»© tá»±
5. Nháº¥p "LÆ°u"

**Then:**
- Toast thÃ´ng bÃ¡o: "Táº¡o máº«u thÃ nh cÃ´ng"
- Máº«u xuáº¥t hiá»‡n trong báº£ng danh sÃ¡ch
- Database cÃ³ báº£n ghi má»›i:
  - Báº£ng `task_templates`: 1 dÃ²ng
  - Báº£ng `task_templates_tasks`: 5 dÃ²ng
- `sequence_order` Ä‘Æ°á»£c Ä‘Ã¡nh sá»‘: 1, 2, 3, 4, 5
- `enforce_sequence` = true
- `is_active` = true
- `version` = 1

**SQL Kiá»ƒm Tra:**
```sql
-- Kiá»ƒm tra template Ä‘Æ°á»£c táº¡o
SELECT id, name, service_type, enforce_sequence, is_active, version
FROM task_templates
WHERE name = 'Sá»­a Chá»¯a MÃ n HÃ¬nh iPhone';

-- Kiá»ƒm tra tasks Ä‘Æ°á»£c liÃªn káº¿t
SELECT tt.name, ttt.sequence_order, ttt.is_required, t.name as task_name
FROM task_templates_tasks ttt
JOIN task_templates tt ON tt.id = ttt.template_id
JOIN task_types t ON t.id = ttt.task_type_id
WHERE tt.name = 'Sá»­a Chá»¯a MÃ n HÃ¬nh iPhone'
ORDER BY ttt.sequence_order;
```

---

#### TC-1.2.2: Chá»‰nh Sá»­a Máº«u Hiá»‡n CÃ³ [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Update Operation

**Given:**
- CÃ³ máº«u "Sá»­a Chá»¯a MÃ n HÃ¬nh iPhone" tá»« TC-1.2.1
- ÄÄƒng nháº­p vá»›i vai trÃ² Quáº£n Trá»‹ ViÃªn

**When:**
1. Nháº¥p nÃºt "Sá»­a" trÃªn máº«u
2. Modal má»Ÿ ra vá»›i dá»¯ liá»‡u Ä‘Ã£ Ä‘iá»n sáºµn
3. Thay Ä‘á»•i tÃªn thÃ nh: "Sá»­a Chá»¯a MÃ n HÃ¬nh iPhone - NÃ¢ng Cao"
4. ThÃªm cÃ´ng viá»‡c thá»© 6: "DÃ¡n kÃ­nh cÆ°á»ng lá»±c" (sau QA)
5. Bá» chá»n "báº¯t buá»™c" cho cÃ´ng viá»‡c "ÄÃ³ng gÃ³i"
6. Nháº¥p "LÆ°u"

**Then:**
- Toast thÃ´ng bÃ¡o: "Cáº­p nháº­t máº«u thÃ nh cÃ´ng"
- TÃªn máº«u thay Ä‘á»•i trong báº£ng
- Version tÄƒng lÃªn 2
- CÃ³ 6 cÃ´ng viá»‡c trong máº«u
- CÃ´ng viá»‡c "ÄÃ³ng gÃ³i" cÃ³ `is_required` = false
- History Ä‘Æ°á»£c giá»¯ (version cÅ© váº«n tá»“n táº¡i náº¿u cÃ³ phiáº¿u Ä‘ang sá»­ dá»¥ng)

**SQL Kiá»ƒm Tra:**
```sql
-- Kiá»ƒm tra version má»›i
SELECT name, version, updated_at
FROM task_templates
WHERE name LIKE 'Sá»­a Chá»¯a MÃ n HÃ¬nh iPhone%'
ORDER BY version DESC;

-- Kiá»ƒm tra sá»‘ lÆ°á»£ng tasks
SELECT COUNT(*) as task_count
FROM task_templates_tasks
WHERE template_id = (
  SELECT id FROM task_templates
  WHERE name LIKE 'Sá»­a Chá»¯a MÃ n HÃ¬nh iPhone%'
  ORDER BY version DESC LIMIT 1
);
```

---

#### TC-1.2.3: XÃ³a Máº«u KhÃ´ng ÄÆ°á»£c Sá»­ Dá»¥ng [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Medium
**Loáº¡i:** Delete Operation

**Given:**
- CÃ³ máº«u "Test Template" chÆ°a Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi phiáº¿u nÃ o
- ÄÄƒng nháº­p vá»›i vai trÃ² Quáº£n Trá»‹ ViÃªn

**When:**
1. Nháº¥p nÃºt "XÃ³a" trÃªn máº«u "Test Template"
2. Dialog xÃ¡c nháº­n hiá»‡n ra
3. Nháº¥p "XÃ¡c nháº­n xÃ³a"

**Then:**
- Toast thÃ´ng bÃ¡o: "XÃ³a máº«u thÃ nh cÃ´ng"
- Máº«u biáº¿n máº¥t khá»i danh sÃ¡ch
- Báº£n ghi trong database bá»‹ xÃ³a (hoáº·c `deleted_at` Ä‘Æ°á»£c set)

---

#### TC-1.2.4: NgÄƒn XÃ³a Máº«u Äang ÄÆ°á»£c Sá»­ Dá»¥ng [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Validation

**Given:**
- CÃ³ máº«u "Sá»­a Chá»¯a MÃ n HÃ¬nh iPhone" Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi 3 phiáº¿u
- ÄÄƒng nháº­p vá»›i vai trÃ² Quáº£n Trá»‹ ViÃªn

**When:**
1. Nháº¥p nÃºt "XÃ³a" trÃªn máº«u
2. Nháº¥p "XÃ¡c nháº­n xÃ³a"

**Then:**
- Toast lá»—i: "KhÃ´ng thá»ƒ xÃ³a máº«u Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi 3 phiáº¿u dá»‹ch vá»¥"
- Máº«u váº«n tá»“n táº¡i trong database
- KhÃ´ng cÃ³ thay Ä‘á»•i dá»¯ liá»‡u

---

#### TC-1.2.5: Xem TrÆ°á»›c Máº«u [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Medium
**Loáº¡i:** Read Operation

**Given:**
- CÃ³ máº«u vá»›i 5 cÃ´ng viá»‡c
- ÄÄƒng nháº­p vá»›i báº¥t ká»³ vai trÃ² nÃ o

**When:**
1. Nháº¥p nÃºt "Xem" trÃªn máº«u
2. Modal preview má»Ÿ ra

**Then:**
- Hiá»ƒn thá»‹ Ä‘áº§y Ä‘á»§ thÃ´ng tin:
  - TÃªn máº«u
  - MÃ´ táº£
  - Loáº¡i dá»‹ch vá»¥ (badge mÃ u)
  - Tráº¡ng thÃ¡i hoáº¡t Ä‘á»™ng
  - Cáº£nh bÃ¡o náº¿u enforce_sequence = true
- Danh sÃ¡ch 5 cÃ´ng viá»‡c vá»›i:
  - Sá»‘ thá»© tá»±
  - TÃªn cÃ´ng viá»‡c
  - Badge "Báº¯t buá»™c" náº¿u is_required = true
  - Thá»i gian Æ°á»›c tÃ­nh

---

#### TC-1.2.6: Kiá»ƒm Tra PhÃ¢n Quyá»n - Manager KhÃ´ng Thá»ƒ Sá»­a [SEC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Authorization

**Given:**
- ÄÄƒng nháº­p vá»›i vai trÃ² Quáº£n LÃ½ (Manager)
- Äang á»Ÿ trang /workflows/templates

**When:**
- Xem danh sÃ¡ch máº«u

**Then:**
- NÃºt "Máº«u Má»›i" KHÃ”NG hiá»ƒn thá»‹
- NÃºt "Sá»­a" KHÃ”NG hiá»ƒn thá»‹
- NÃºt "XÃ³a" KHÃ”NG hiá»ƒn thá»‹
- Chá»‰ cÃ³ nÃºt "Xem" kháº£ dá»¥ng
- tRPC mutation bá»‹ tá»« chá»‘i náº¿u gá»i trá»±c tiáº¿p

---

### Story 1.3: Automatic Task Generation

**Má»¥c tiÃªu:** Tá»± Ä‘á»™ng táº¡o cÃ´ng viá»‡c khi táº¡o phiáº¿u dá»‹ch vá»¥

#### TC-1.3.1: Tá»± Äá»™ng Táº¡o CÃ´ng Viá»‡c Khi Táº¡o Phiáº¿u [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Trigger Automation

**Given:**
- CÃ³ máº«u "Sá»­a Chá»¯a MÃ n HÃ¬nh iPhone" vá»›i 5 cÃ´ng viá»‡c
- Máº«u cÃ³ service_type = "paid"
- Sáº£n pháº©m iPhone 13 Pro tá»“n táº¡i
- ÄÄƒng nháº­p vá»›i vai trÃ² Lá»… TÃ¢n

**When:**
1. Äiá»u hÆ°á»›ng Ä‘áº¿n /tickets/add
2. Táº¡o phiáº¿u má»›i:
   - KhÃ¡ch hÃ ng: Nguyá»…n VÄƒn A
   - Sáº£n pháº©m: iPhone 13 Pro
   - Loáº¡i báº£o hÃ nh: "Tráº£ phÃ­" (paid)
   - Váº¥n Ä‘á»: "MÃ n hÃ¬nh bá»‹ vá»¡"
3. HoÃ n thÃ nh táº¡o phiáº¿u

**Then:**
- Phiáº¿u Ä‘Æ°á»£c táº¡o thÃ nh cÃ´ng
- 5 cÃ´ng viá»‡c Ä‘Æ°á»£c tá»± Ä‘á»™ng táº¡o trong `service_ticket_tasks`:
  - Táº¥t cáº£ cÃ³ status = "pending"
  - sequence_order: 1, 2, 3, 4, 5
  - is_required Ä‘Ãºng vá»›i cáº¥u hÃ¬nh máº«u
  - task_type_id khá»›p vá»›i máº«u
- Khi má»Ÿ trang chi tiáº¿t phiáº¿u â†’ hiá»ƒn thá»‹ 5 cÃ´ng viá»‡c

**SQL Kiá»ƒm Tra:**
```sql
-- Kiá»ƒm tra tasks Ä‘Æ°á»£c táº¡o
SELECT
  t.ticket_number,
  stt.sequence_order,
  tt.name as task_name,
  stt.status,
  stt.is_required
FROM service_ticket_tasks stt
JOIN service_tickets t ON t.id = stt.ticket_id
JOIN task_types tt ON tt.id = stt.task_type_id
WHERE t.ticket_number = 'SV-2025-XXX' -- Thay báº±ng sá»‘ phiáº¿u thá»±c táº¿
ORDER BY stt.sequence_order;
```

---

#### TC-1.3.2: KhÃ´ng Táº¡o Task Náº¿u KhÃ´ng CÃ³ Máº«u PhÃ¹ Há»£p [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Medium
**Loáº¡i:** Edge Case

**Given:**
- KhÃ´ng cÃ³ máº«u nÃ o cho service_type = "warranty" + product "Samsung Galaxy"
- ÄÄƒng nháº­p vá»›i vai trÃ² Lá»… TÃ¢n

**When:**
1. Táº¡o phiáº¿u má»›i:
   - Sáº£n pháº©m: Samsung Galaxy S23
   - Loáº¡i báº£o hÃ nh: "Báº£o hÃ nh" (warranty)
2. HoÃ n thÃ nh táº¡o phiáº¿u

**Then:**
- Phiáº¿u Ä‘Æ°á»£c táº¡o thÃ nh cÃ´ng
- KhÃ´ng cÃ³ cÃ´ng viá»‡c nÃ o Ä‘Æ°á»£c táº¡o
- Trang chi tiáº¿t phiáº¿u hiá»ƒn thá»‹ thÃ´ng bÃ¡o: "ChÆ°a cÃ³ máº«u cÃ´ng viá»‡c Ä‘Æ°á»£c Ã¡p dá»¥ng"

---

#### TC-1.3.3: Xá»­ LÃ½ NULL product_id [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Medium
**Loáº¡i:** Edge Case

**Given:**
- Phiáº¿u khÃ´ng cÃ³ product_id (dá»‹ch vá»¥ tá»•ng quÃ¡t)
- ÄÄƒng nháº­p vá»›i vai trÃ² Lá»… TÃ¢n

**When:**
- Táº¡o phiáº¿u khÃ´ng chá»n sáº£n pháº©m

**Then:**
- Phiáº¿u Ä‘Æ°á»£c táº¡o thÃ nh cÃ´ng
- KhÃ´ng cÃ³ cÃ´ng viá»‡c nÃ o Ä‘Æ°á»£c táº¡o
- KhÃ´ng cÃ³ lá»—i xáº£y ra
- CÃ³ thá»ƒ thÃªm cÃ´ng viá»‡c thá»§ cÃ´ng sau

---

## Phase 2: Core Workflow

### Story 1.4: Task Execution UI

**Má»¥c tiÃªu:** Giao diá»‡n thá»±c hiá»‡n cÃ´ng viá»‡c cho Ká»¹ Thuáº­t ViÃªn

#### TC-1.4.1: Xem Danh SÃ¡ch CÃ´ng Viá»‡c ÄÆ°á»£c Giao [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Read Operation

**Given:**
- ÄÄƒng nháº­p vá»›i vai trÃ² Ká»¹ Thuáº­t ViÃªn 1 (tech1@test.com)
- CÃ³ 3 phiáº¿u Ä‘Æ°á»£c giao cho Ká»¹ Thuáº­t ViÃªn 1
- Má»—i phiáº¿u cÃ³ 5 cÃ´ng viá»‡c

**When:**
- Äiá»u hÆ°á»›ng Ä‘áº¿n /my-tasks

**Then:**
- Hiá»ƒn thá»‹ 3 nhÃ³m (theo phiáº¿u)
- Má»—i nhÃ³m hiá»ƒn thá»‹:
  - Sá»‘ phiáº¿u (SV-2025-XXX)
  - TÃªn khÃ¡ch hÃ ng
  - Thanh tiáº¿n Ä‘á»™ (X/5 hoÃ n thÃ nh)
  - Danh sÃ¡ch cÃ´ng viá»‡c
- Statistics cards hiá»ƒn thá»‹:
  - Tá»•ng: 15 cÃ´ng viá»‡c
  - Chá» xá»­ lÃ½: X
  - Äang xá»­ lÃ½: Y
  - HoÃ n thÃ nh: Z
  - Bá»‹ cháº·n: 0

---

#### TC-1.4.2: Báº¯t Äáº§u CÃ´ng Viá»‡c [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** State Transition

**Given:**
- ÄÄƒng nháº­p vá»›i vai trÃ² Ká»¹ Thuáº­t ViÃªn
- CÃ³ cÃ´ng viá»‡c vá»›i status = "pending"
- Äang á»Ÿ trang /my-tasks

**When:**
1. Nháº¥p nÃºt "Báº¯t Äáº§u" trÃªn cÃ´ng viá»‡c
2. XÃ¡c nháº­n

**Then:**
- Toast thÃ´ng bÃ¡o: "Báº¯t Ä‘áº§u cÃ´ng viá»‡c thÃ nh cÃ´ng"
- Status cÃ´ng viá»‡c chuyá»ƒn thÃ nh "in_progress"
- `started_at` Ä‘Æ°á»£c set = now()
- Icon cÃ´ng viá»‡c thay Ä‘á»•i thÃ nh icon "in progress"
- NÃºt "Báº¯t Äáº§u" biáº¿n máº¥t
- NÃºt "HoÃ n ThÃ nh" vÃ  "Cháº·n" xuáº¥t hiá»‡n
- Statistics card "Äang xá»­ lÃ½" tÄƒng 1
- Cache tá»± Ä‘á»™ng refresh

**SQL Kiá»ƒm Tra:**
```sql
SELECT status, started_at, completed_at
FROM service_ticket_tasks
WHERE id = 'task_id_here';
```

---

#### TC-1.4.3: HoÃ n ThÃ nh CÃ´ng Viá»‡c Vá»›i Ghi ChÃº [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** State Transition + Validation

**Given:**
- CÃ´ng viá»‡c cÃ³ status = "in_progress"
- Äang á»Ÿ trang /my-tasks

**When:**
1. Nháº¥p nÃºt "HoÃ n ThÃ nh"
2. Modal má»Ÿ ra yÃªu cáº§u ghi chÃº
3. Nháº­p ghi chÃº: "ÄÃ£ thay mÃ n hÃ¬nh thÃ nh cÃ´ng. MÃ n hÃ¬nh má»›i hoáº¡t Ä‘á»™ng tá»‘t."
4. Nháº¥p "XÃ¡c nháº­n"

**Then:**
- Toast thÃ´ng bÃ¡o: "HoÃ n thÃ nh cÃ´ng viá»‡c thÃ nh cÃ´ng"
- Status chuyá»ƒn thÃ nh "completed"
- `completed_at` Ä‘Æ°á»£c set = now()
- `actual_duration_minutes` Ä‘Æ°á»£c tÃ­nh = completed_at - started_at
- Completion notes Ä‘Æ°á»£c lÆ°u
- Icon cÃ´ng viá»‡c thay Ä‘á»•i thÃ nh icon "completed"
- Statistics card "HoÃ n thÃ nh" tÄƒng 1
- NÃºt action biáº¿n máº¥t (task Ä‘Ã£ xong)

---

#### TC-1.4.4: Validation Ghi ChÃº HoÃ n ThÃ nh [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Validation

**Given:**
- Modal "HoÃ n thÃ nh cÃ´ng viá»‡c" Ä‘ang má»Ÿ

**When:**
1. Äá»ƒ trá»‘ng ghi chÃº
2. Nháº¥p "XÃ¡c nháº­n"

**Then:**
- Hiá»ƒn thá»‹ lá»—i: "Ghi chÃº hoÃ n thÃ nh lÃ  báº¯t buá»™c (tá»‘i thiá»ƒu 5 kÃ½ tá»±)"
- Modal khÃ´ng Ä‘Ã³ng
- CÃ´ng viá»‡c váº«n cÃ³ status = "in_progress"

**When:**
1. Nháº­p ghi chÃº: "OK"
2. Nháº¥p "XÃ¡c nháº­n"

**Then:**
- Hiá»ƒn thá»‹ lá»—i: "Ghi chÃº hoÃ n thÃ nh pháº£i cÃ³ Ã­t nháº¥t 5 kÃ½ tá»±"
- Modal khÃ´ng Ä‘Ã³ng

---

#### TC-1.4.5: Cháº·n CÃ´ng Viá»‡c Vá»›i LÃ½ Do [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** State Transition

**Given:**
- CÃ´ng viá»‡c cÃ³ status = "in_progress"
- Äang á»Ÿ trang /my-tasks

**When:**
1. Nháº¥p nÃºt "Cháº·n"
2. Dialog yÃªu cáº§u lÃ½ do
3. Nháº­p lÃ½ do: "Thiáº¿u linh kiá»‡n mÃ n hÃ¬nh, chá» nháº­p hÃ ng"
4. XÃ¡c nháº­n

**Then:**
- Toast thÃ´ng bÃ¡o: "ÄÃ£ cháº·n cÃ´ng viá»‡c"
- Status chuyá»ƒn thÃ nh "blocked"
- LÃ½ do Ä‘Æ°á»£c lÆ°u vÃ o notes
- Icon cÃ´ng viá»‡c thay Ä‘á»•i thÃ nh icon "blocked"
- Statistics card "Bá»‹ cháº·n" tÄƒng 1
- NÃºt "Tiáº¿p Tá»¥c" xuáº¥t hiá»‡n thay cho "HoÃ n ThÃ nh"

---

#### TC-1.4.6: Tiáº¿p Tá»¥c CÃ´ng Viá»‡c Bá»‹ Cháº·n [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** State Transition

**Given:**
- CÃ´ng viá»‡c cÃ³ status = "blocked"

**When:**
1. Nháº¥p nÃºt "Tiáº¿p Tá»¥c"
2. XÃ¡c nháº­n

**Then:**
- Toast thÃ´ng bÃ¡o: "Tiáº¿p tá»¥c cÃ´ng viá»‡c thÃ nh cÃ´ng"
- Status chuyá»ƒn láº¡i thÃ nh "in_progress"
- Statistics card cáº­p nháº­t
- NÃºt "HoÃ n ThÃ nh" vÃ  "Cháº·n" xuáº¥t hiá»‡n láº¡i

---

#### TC-1.4.7: Auto-Refresh Má»—i 30 GiÃ¢y [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Medium
**Loáº¡i:** Real-time Updates

**Given:**
- Äang á»Ÿ trang /my-tasks
- Tab Ä‘ang active (khÃ´ng minimize)

**When:**
- Chá» 30 giÃ¢y

**Then:**
- TanStack Query tá»± Ä‘á»™ng refetch dá»¯ liá»‡u
- Danh sÃ¡ch cÃ´ng viá»‡c cáº­p nháº­t náº¿u cÃ³ thay Ä‘á»•i tá»« database
- KhÃ´ng cÃ³ loading indicator toÃ n trang (background refresh)
- Statistics cards cáº­p nháº­t

---

#### TC-1.4.8: Chá»‰ Xem CÃ´ng Viá»‡c ÄÆ°á»£c Giao Cho MÃ¬nh [SEC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Authorization

**Given:**
- Ká»¹ Thuáº­t ViÃªn 1 cÃ³ 5 cÃ´ng viá»‡c
- Ká»¹ Thuáº­t ViÃªn 2 cÃ³ 3 cÃ´ng viá»‡c

**When:**
- ÄÄƒng nháº­p vá»›i Ká»¹ Thuáº­t ViÃªn 1
- Má»Ÿ /my-tasks

**Then:**
- Chá»‰ hiá»ƒn thá»‹ 5 cÃ´ng viá»‡c cá»§a Ká»¹ Thuáº­t ViÃªn 1
- KHÃ”NG hiá»ƒn thá»‹ cÃ´ng viá»‡c cá»§a Ká»¹ Thuáº­t ViÃªn 2
- tRPC query filter theo `assigned_to = current_user_id`

---

### Story 1.5: Task Dependencies and Status Automation

**Má»¥c tiÃªu:** Thá»±c thi trÃ¬nh tá»± cÃ´ng viá»‡c vÃ  tá»± Ä‘á»™ng nÃ¢ng tráº¡ng thÃ¡i phiáº¿u

#### TC-1.5.1: NgÄƒn Cháº·n Thá»±c Hiá»‡n KhÃ´ng ÄÃºng Thá»© Tá»± (Strict Mode) [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Sequence Enforcement

**Given:**
- Phiáº¿u cÃ³ máº«u vá»›i `enforce_sequence` = true
- CÃ´ng viá»‡c 1: "Tiáº¿p nháº­n" - completed
- CÃ´ng viá»‡c 2: "Cháº©n Ä‘oÃ¡n" - pending
- CÃ´ng viá»‡c 3: "Sá»­a chá»¯a" - pending
- ÄÄƒng nháº­p vá»›i vai trÃ² Ká»¹ Thuáº­t ViÃªn

**When:**
1. Cá»‘ gáº¯ng nháº¥p "Báº¯t Äáº§u" trÃªn cÃ´ng viá»‡c 3 (bá» qua cÃ´ng viá»‡c 2)

**Then:**
- NÃºt "Báº¯t Äáº§u" bá»‹ disable
- Icon khÃ³a xuáº¥t hiá»‡n
- Tooltip hiá»ƒn thá»‹: "Pháº£i hoÃ n thÃ nh cÃ´ng viá»‡c trÆ°á»›c Ä‘Ã³: Cháº©n Ä‘oÃ¡n"
- KhÃ´ng thá»ƒ thay Ä‘á»•i status
- Database trigger `check_task_sequence_gate` ngÄƒn cháº·n UPDATE

**SQL Kiá»ƒm Tra:**
```sql
-- Thá»­ update trá»±c tiáº¿p (sáº½ bá»‹ reject)
UPDATE service_ticket_tasks
SET status = 'in_progress'
WHERE sequence_order = 3
AND ticket_id = 'ticket_id_here';
-- Expected: ERROR: Cannot start task out of sequence
```

---

#### TC-1.5.2: Cáº£nh BÃ¡o Thá»±c Hiá»‡n KhÃ´ng ÄÃºng Thá»© Tá»± (Flexible Mode) [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Warning Display

**Given:**
- Phiáº¿u cÃ³ máº«u vá»›i `enforce_sequence` = false
- CÃ´ng viá»‡c 2: "Cháº©n Ä‘oÃ¡n" - pending
- CÃ´ng viá»‡c 3: "Sá»­a chá»¯a" - pending

**When:**
1. Báº¯t Ä‘áº§u cÃ´ng viá»‡c 3 trÆ°á»›c cÃ´ng viá»‡c 2
2. Cá»‘ gáº¯ng hoÃ n thÃ nh cÃ´ng viá»‡c 3

**Then:**
- Cho phÃ©p báº¯t Ä‘áº§u cÃ´ng viá»‡c 3
- Icon cáº£nh bÃ¡o (âš ï¸) xuáº¥t hiá»‡n
- Modal hoÃ n thÃ nh hiá»ƒn thá»‹ cáº£nh bÃ¡o:
  - "Báº¡n Ä‘ang hoÃ n thÃ nh cÃ´ng viá»‡c khÃ´ng Ä‘Ãºng thá»© tá»±"
  - "CÃ´ng viá»‡c trÆ°á»›c Ä‘Ã³ chÆ°a hoÃ n thÃ nh: Cháº©n Ä‘oÃ¡n"
  - Checkbox xÃ¡c nháº­n: "TÃ´i hiá»ƒu vÃ  muá»‘n tiáº¿p tá»¥c"
- Váº«n cho phÃ©p hoÃ n thÃ nh sau khi xÃ¡c nháº­n

---

#### TC-1.5.3: Tá»± Äá»™ng NÃ¢ng Phiáº¿u LÃªn "Äang Xá»­ LÃ½" [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Auto Status Transition

**Given:**
- Phiáº¿u cÃ³ status = "pending"
- Phiáº¿u cÃ³ 5 cÃ´ng viá»‡c, táº¥t cáº£ status = "pending"

**When:**
1. Ká»¹ thuáº­t viÃªn báº¯t Ä‘áº§u cÃ´ng viá»‡c Ä‘áº§u tiÃªn
2. Status cÃ´ng viá»‡c chuyá»ƒn tá»« "pending" â†’ "in_progress"

**Then:**
- Trigger `auto_advance_ticket_status` kÃ­ch hoáº¡t
- Phiáº¿u tá»± Ä‘á»™ng chuyá»ƒn status tá»« "pending" â†’ "in_progress"
- ThÃ´ng bÃ¡o Ä‘Æ°á»£c log vÃ o `service_ticket_comments`:
  - Loáº¡i: "system"
  - Ná»™i dung: "Phiáº¿u tá»± Ä‘á»™ng chuyá»ƒn sang 'Äang xá»­ lÃ½' khi cÃ´ng viá»‡c Ä‘áº§u tiÃªn báº¯t Ä‘áº§u"
- `started_at` cá»§a phiáº¿u Ä‘Æ°á»£c set = now()

**SQL Kiá»ƒm Tra:**
```sql
-- Kiá»ƒm tra phiáº¿u Ä‘Ã£ nÃ¢ng status
SELECT ticket_number, status, started_at
FROM service_tickets
WHERE id = 'ticket_id_here';

-- Kiá»ƒm tra comment tá»± Ä‘á»™ng
SELECT comment_text, comment_type, created_at
FROM service_ticket_comments
WHERE ticket_id = 'ticket_id_here'
AND comment_type = 'system'
ORDER BY created_at DESC
LIMIT 1;
```

---

#### TC-1.5.4: Tá»± Äá»™ng HoÃ n ThÃ nh Phiáº¿u Khi Táº¥t Cáº£ Task Xong [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Auto Status Transition

**Given:**
- Phiáº¿u cÃ³ status = "in_progress"
- Phiáº¿u cÃ³ 5 cÃ´ng viá»‡c:
  - 4 cÃ´ng viá»‡c báº¯t buá»™c: completed
  - 1 cÃ´ng viá»‡c tÃ¹y chá»n: pending

**When:**
- HoÃ n thÃ nh cÃ´ng viá»‡c báº¯t buá»™c cuá»‘i cÃ¹ng

**Then:**
- Trigger `auto_advance_ticket_status` kiá»ƒm tra:
  - Táº¥t cáº£ cÃ´ng viá»‡c báº¯t buá»™c Ä‘Ã£ completed âœ“
  - CÃ´ng viá»‡c tÃ¹y chá»n cÃ³ thá»ƒ bá» qua âœ“
- Phiáº¿u tá»± Ä‘á»™ng chuyá»ƒn status â†’ "completed"
- `completed_at` cá»§a phiáº¿u Ä‘Æ°á»£c set = now()
- Comment tá»± Ä‘á»™ng: "Phiáº¿u tá»± Ä‘á»™ng hoÃ n thÃ nh khi táº¥t cáº£ cÃ´ng viá»‡c báº¯t buá»™c Ä‘Ã£ xong"

---

#### TC-1.5.5: KhÃ´ng Tá»± Äá»™ng HoÃ n ThÃ nh Náº¿u CÃ²n Task Báº¯t Buá»™c [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Validation

**Given:**
- Phiáº¿u cÃ³ 5 cÃ´ng viá»‡c báº¯t buá»™c
- 4 cÃ´ng viá»‡c: completed
- 1 cÃ´ng viá»‡c báº¯t buá»™c: blocked

**When:**
- HoÃ n thÃ nh cÃ´ng viá»‡c báº¯t buá»™c thá»© 4

**Then:**
- Phiáº¿u VáºªN á»Ÿ status = "in_progress"
- KHÃ”NG tá»± Ä‘á»™ng chuyá»ƒn sang "completed"
- LÃ½ do: cÃ²n 1 cÃ´ng viá»‡c báº¯t buá»™c bá»‹ blocked

---

#### TC-1.5.6: Kiá»ƒm Tra Dependency Indicator UI [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Medium
**Loáº¡i:** UI Component

**Given:**
- Phiáº¿u vá»›i strict sequence
- Äang á»Ÿ trang chi tiáº¿t phiáº¿u hoáº·c /my-tasks

**When:**
- Xem danh sÃ¡ch cÃ´ng viá»‡c

**Then:**
- Component `TaskDependencyIndicator` hiá»ƒn thá»‹:
  - CÃ´ng viá»‡c Ä‘Ã£ hoÃ n thÃ nh: Icon âœ“ (xanh)
  - CÃ´ng viá»‡c hiá»‡n táº¡i cÃ³ thá»ƒ lÃ m: KhÃ´ng cÃ³ icon
  - CÃ´ng viá»‡c bá»‹ khÃ³a: Icon ğŸ”’ (xÃ¡m) + tooltip
- Tooltip cá»§a task bá»‹ khÃ³a hiá»ƒn thá»‹:
  - "Pháº£i hoÃ n thÃ nh cÃ´ng viá»‡c trÆ°á»›c Ä‘Ã³"
  - TÃªn cÃ´ng viá»‡c cáº§n hoÃ n thÃ nh

---

## Phase 3: Warehouse Foundation

### Story 1.6: Warehouse Hierarchy Setup

**Má»¥c tiÃªu:** Thiáº¿t láº­p há»‡ thá»‘ng kho (váº­t lÃ½, áº£o, nhÃ  cung cáº¥p)

#### TC-1.6.1: Kiá»ƒm Tra Virtual Warehouses ÄÆ°á»£c Seed [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Data Seeding

**Given:**
- Migration `20251024000002_seed_virtual_warehouses.sql` Ä‘Ã£ cháº¡y

**When:**
- Truy váº¥n báº£ng `virtual_warehouses`

**Then:**
- 4 kho áº£o tá»“n táº¡i:
  - "Kho Báº£o HÃ nh" (warranty_stock)
  - "Kho RMA" (rma_staging)
  - "Kho HÆ° Há»ng" (dead_stock)
  - "Äang Sá»­a Chá»¯a" (in_service)
- Táº¥t cáº£ cÃ³ `is_active` = true

**SQL Kiá»ƒm Tra:**
```sql
SELECT name, warehouse_type, is_active
FROM virtual_warehouses
ORDER BY name;
```

---

#### TC-1.6.2: Táº¡o Kho Váº­t LÃ½ Má»›i [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Create Operation

**Given:**
- ÄÄƒng nháº­p vá»›i vai trÃ² Quáº£n Trá»‹ ViÃªn
- Äang á»Ÿ trang /warehouses

**When:**
1. Nháº¥p "ThÃªm Kho Váº­t LÃ½"
2. Äiá»n thÃ´ng tin:
   - TÃªn: "Kho Trung TÃ¢m HÃ  Ná»™i"
   - MÃ£ kho: "HN-001"
   - Äá»‹a chá»‰: "123 Tráº§n Duy HÆ°ng, Cáº§u Giáº¥y, HÃ  Ná»™i"
   - MÃ´ táº£: "Kho chÃ­nh táº¡i trung tÃ¢m HÃ  Ná»™i"
3. Nháº¥p "LÆ°u"

**Then:**
- Toast thÃ´ng bÃ¡o: "Táº¡o kho váº­t lÃ½ thÃ nh cÃ´ng"
- Báº£n ghi má»›i trong `physical_warehouses`
- Kho hiá»ƒn thá»‹ trong báº£ng danh sÃ¡ch
- `is_active` = true máº·c Ä‘á»‹nh

---

#### TC-1.6.3: Chá»‰ Admin CÃ³ Thá»ƒ Quáº£n LÃ½ Kho [SEC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Authorization

**Given:**
- ÄÄƒng nháº­p vá»›i vai trÃ² Manager

**When:**
- Truy cáº­p /warehouses

**Then:**
- NÃºt "ThÃªm Kho" KHÃ”NG hiá»ƒn thá»‹
- NÃºt "Sá»­a" vÃ  "XÃ³a" KHÃ”NG hiá»ƒn thá»‹
- Chá»‰ xem Ä‘Æ°á»£c danh sÃ¡ch (read-only)

---

### Story 1.7: Physical Product Master Data

**Má»¥c tiÃªu:** Quáº£n lÃ½ sáº£n pháº©m váº­t lÃ½ vá»›i serial number

#### TC-1.7.1: ÄÄƒng KÃ½ Sáº£n Pháº©m Váº­t LÃ½ [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Create Operation

**Given:**
- ÄÄƒng nháº­p vá»›i vai trÃ² Manager
- Äang á»Ÿ trang /dashboard/inventory/products
- CÃ³ sáº£n pháº©m "iPhone 13 Pro" trong catalog

**When:**
1. Nháº¥p "ÄÄƒng KÃ½ Sáº£n Pháº©m"
2. Äiá»n thÃ´ng tin:
   - Sáº£n pháº©m: "iPhone 13 Pro"
   - Serial Number: "SN-IP13P-12345"
   - IMEI: "123456789012345"
   - NgÃ y mua: "2025-01-15"
   - NhÃ  cung cáº¥p: "Apple Authorized Store"
   - Tráº¡ng thÃ¡i báº£o hÃ nh: "CÃ²n báº£o hÃ nh" (in_warranty)
   - NgÃ y háº¿t báº£o hÃ nh: "2026-01-15"
   - Kho hiá»‡n táº¡i: "Kho Báº£o HÃ nh"
3. Upload áº£nh sáº£n pháº©m (tÃ¹y chá»n)
4. Nháº¥p "LÆ°u"

**Then:**
- Toast thÃ´ng bÃ¡o: "ÄÄƒng kÃ½ sáº£n pháº©m thÃ nh cÃ´ng"
- Báº£n ghi má»›i trong `physical_products`
- Serial number lÃ  unique
- Sáº£n pháº©m hiá»ƒn thá»‹ trong báº£ng inventory
- áº¢nh Ä‘Æ°á»£c upload lÃªn Supabase Storage (náº¿u cÃ³)

**SQL Kiá»ƒm Tra:**
```sql
SELECT
  serial_number, imei, warranty_status,
  purchase_date, warranty_expiry_date,
  current_warehouse_id
FROM physical_products
WHERE serial_number = 'SN-IP13P-12345';
```

---

#### TC-1.7.2: Validation Serial Number TrÃ¹ng Láº·p [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Validation

**Given:**
- ÄÃ£ cÃ³ sáº£n pháº©m vá»›i serial "SN-IP13P-12345"

**When:**
1. Thá»­ Ä‘Äƒng kÃ½ sáº£n pháº©m má»›i
2. Nháº­p serial "SN-IP13P-12345"
3. Nháº¥p "LÆ°u"

**Then:**
- Lá»—i hiá»ƒn thá»‹: "Serial number Ä‘Ã£ tá»“n táº¡i"
- KhÃ´ng táº¡o báº£n ghi má»›i
- Database constraint `unique(serial_number)` ngÄƒn cháº·n

---

#### TC-1.7.3: Tá»± Äá»™ng TÃ­nh Warranty Status [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Medium
**Loáº¡i:** Business Logic

**Given:**
- HÃ´m nay lÃ  2025-10-25
- Sáº£n pháº©m cÃ³ `warranty_expiry_date` = 2025-09-01

**When:**
- View sáº£n pháº©m trong báº£ng inventory

**Then:**
- TrÆ°á»ng `warranty_status` tá»± Ä‘á»™ng lÃ  "out_of_warranty"
- Badge mÃ u Ä‘á» hiá»ƒn thá»‹ "Háº¿t báº£o hÃ nh"

---

#### TC-1.7.4: Upload áº¢nh Sáº£n Pháº©m [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Medium
**Loáº¡i:** File Upload

**Given:**
- Äang á»Ÿ form Ä‘Äƒng kÃ½ sáº£n pháº©m
- CÃ³ file áº£nh "iphone.jpg" (2MB, JPG format)

**When:**
1. Nháº¥p "Upload áº¢nh"
2. Chá»n file "iphone.jpg"
3. Xem preview
4. Nháº¥p "LÆ°u"

**Then:**
- áº¢nh Ä‘Æ°á»£c upload lÃªn bucket `product_images`
- Filename Ä‘Æ°á»£c sanitize (bá» dáº¥u tiáº¿ng Viá»‡t)
- URL áº£nh Ä‘Æ°á»£c lÆ°u trong `physical_products.photo_url`
- áº¢nh hiá»ƒn thá»‹ trong báº£ng inventory

---

## Phase 4: Warehouse Operations

### Story 1.8: Serial Verification and Stock Movements

**Má»¥c tiÃªu:** XÃ¡c minh serial vÃ  ghi nháº­n di chuyá»ƒn kho

#### TC-1.8.1: XÃ¡c Minh Serial Number [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Verification

**Given:**
- CÃ³ sáº£n pháº©m vá»›i serial "SN-IP13P-001" trong database
- Äang á»Ÿ trang public portal /service-request

**When:**
1. Nháº­p serial: "SN-IP13P-001"
2. Nháº¥p "XÃ¡c Minh"

**Then:**
- Hiá»ƒn thá»‹ thÃ´ng tin sáº£n pháº©m:
  - TÃªn: "iPhone 13 Pro 128GB Blue"
  - Tráº¡ng thÃ¡i báº£o hÃ nh: "CÃ²n báº£o hÃ nh"
  - NgÃ y háº¿t báº£o hÃ nh: "15/01/2026"
  - Icon âœ“ (xanh)
- Cho phÃ©p tiáº¿p tá»¥c táº¡o yÃªu cáº§u

---

#### TC-1.8.2: Serial KhÃ´ng Tá»“n Táº¡i [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Error Handling

**Given:**
- Serial "SN-INVALID-999" khÃ´ng tá»“n táº¡i trong database

**When:**
1. Nháº­p serial: "SN-INVALID-999"
2. Nháº¥p "XÃ¡c Minh"

**Then:**
- Hiá»ƒn thá»‹ lá»—i: "Serial number khÃ´ng tá»“n táº¡i trong há»‡ thá»‘ng"
- Gá»£i Ã½: "Vui lÃ²ng kiá»ƒm tra láº¡i hoáº·c liÃªn há»‡ trung tÃ¢m"
- Icon âœ— (Ä‘á»)
- KhÃ´ng cho phÃ©p tiáº¿p tá»¥c

---

#### TC-1.8.3: Ghi Nháº­n Di Chuyá»ƒn Kho [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Stock Movement

**Given:**
- ÄÄƒng nháº­p vá»›i vai trÃ² Manager
- Sáº£n pháº©m "SN-IP13P-001" Ä‘ang á»Ÿ "Kho Báº£o HÃ nh"
- Äang á»Ÿ trang /dashboard/inventory/stock-levels

**When:**
1. Chá»n sáº£n pháº©m "SN-IP13P-001"
2. Nháº¥p "Di Chuyá»ƒn"
3. Dialog má»Ÿ ra:
   - Tá»« kho: "Kho Báº£o HÃ nh" (auto-fill)
   - Äáº¿n kho: Chá»n "Äang Sá»­a Chá»¯a"
   - LÃ½ do: "Chuyá»ƒn sang sá»­a chá»¯a"
   - Ghi chÃº: "KhÃ¡ch hÃ ng gá»­i sá»­a mÃ n hÃ¬nh"
4. Nháº¥p "XÃ¡c nháº­n"

**Then:**
- Toast thÃ´ng bÃ¡o: "Di chuyá»ƒn kho thÃ nh cÃ´ng"
- Báº£n ghi má»›i trong `stock_movements`:
  - product_id, from_warehouse, to_warehouse
  - movement_type = 'transfer'
  - moved_by = current_user_id
  - moved_at = now()
- `physical_products.current_warehouse_id` cáº­p nháº­t = "Äang Sá»­a Chá»¯a"
- Lá»‹ch sá»­ di chuyá»ƒn hiá»ƒn thá»‹ trong timeline

**SQL Kiá»ƒm Tra:**
```sql
-- Kiá»ƒm tra warehouse hiá»‡n táº¡i
SELECT serial_number, current_warehouse_id
FROM physical_products
WHERE serial_number = 'SN-IP13P-001';

-- Kiá»ƒm tra lá»‹ch sá»­
SELECT movement_type, from_warehouse_id, to_warehouse_id, moved_at
FROM stock_movements
WHERE product_id = (
  SELECT id FROM physical_products WHERE serial_number = 'SN-IP13P-001'
)
ORDER BY moved_at DESC;
```

---

#### TC-1.8.4: Tá»± Äá»™ng Di Chuyá»ƒn Khi Phiáº¿u Chuyá»ƒn Tráº¡ng ThÃ¡i [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Trigger Automation

**Given:**
- Phiáº¿u cÃ³ product "SN-IP13P-001"
- Sáº£n pháº©m Ä‘ang á»Ÿ "Kho Báº£o HÃ nh"
- Phiáº¿u cÃ³ status = "pending"

**When:**
- Cáº­p nháº­t phiáº¿u status â†’ "in_progress"

**Then:**
- Trigger `auto_move_product_on_ticket_event` kÃ­ch hoáº¡t
- Sáº£n pháº©m tá»± Ä‘á»™ng di chuyá»ƒn:
  - Tá»«: "Kho Báº£o HÃ nh"
  - Äáº¿n: "Äang Sá»­a Chá»¯a"
- Báº£n ghi `stock_movements` vá»›i:
  - movement_type = 'ticket_start'
  - notes = "Tá»± Ä‘á»™ng di chuyá»ƒn khi phiáº¿u {ticket_number} báº¯t Ä‘áº§u"

**When:**
- Cáº­p nháº­t phiáº¿u status â†’ "completed"

**Then:**
- Sáº£n pháº©m tá»± Ä‘á»™ng di chuyá»ƒn:
  - Tá»«: "Äang Sá»­a Chá»¯a"
  - Äáº¿n: "Kho Báº£o HÃ nh" (hoáº·c kho ban Ä‘áº§u)
- movement_type = 'ticket_complete'

---

### Story 1.9: Warehouse Stock Levels and Low Stock Alerts

**Má»¥c tiÃªu:** Hiá»ƒn thá»‹ má»©c tá»“n kho vÃ  cáº£nh bÃ¡o tá»“n kho tháº¥p

#### TC-1.9.1: Xem Má»©c Tá»“n Kho Theo Kho [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Materialized View Query

**Given:**
- CÃ³ 100 sáº£n pháº©m phÃ¢n bá»• trong cÃ¡c kho
- ÄÄƒng nháº­p vá»›i vai trÃ² Manager
- Äang á»Ÿ trang /dashboard/inventory/stock-levels

**When:**
- Trang load

**Then:**
- Hiá»ƒn thá»‹ báº£ng vá»›i cÃ¡c cá»™t:
  - Kho (warehouse_name)
  - Tá»•ng sáº£n pháº©m (total_products)
  - CÃ²n báº£o hÃ nh (in_warranty_count)
  - Háº¿t báº£o hÃ nh (out_of_warranty_count)
  - Cáº£nh bÃ¡o tá»“n kho tháº¥p (low_stock_count)
- Dá»¯ liá»‡u láº¥y tá»« view `v_warehouse_stock_levels`
- Thá»i gian táº£i < 200ms

**SQL Kiá»ƒm Tra:**
```sql
SELECT * FROM v_warehouse_stock_levels
ORDER BY warehouse_name;
```

---

#### TC-1.9.2: Cáº£nh BÃ¡o Tá»“n Kho Tháº¥p [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Alert System

**Given:**
- Sáº£n pháº©m "iPhone 13 Pro" cÃ³ `low_stock_threshold` = 10
- Hiá»‡n cÃ³ 9 cÃ¡i trong "Kho Báº£o HÃ nh"

**When:**
- Xem trang stock levels

**Then:**
- Badge cáº£nh bÃ¡o mÃ u Ä‘á» hiá»ƒn thá»‹: "Tá»“n kho tháº¥p"
- Sá»‘ lÆ°á»£ng hiá»ƒn thá»‹ mÃ u Ä‘á»: "9 / 10"
- Icon âš ï¸ xuáº¥t hiá»‡n
- Alert box á»Ÿ Ä‘áº§u trang:
  - "CÃ³ 1 sáº£n pháº©m tá»“n kho tháº¥p cáº§n nháº­p hÃ ng"
  - Danh sÃ¡ch sáº£n pháº©m cáº§n nháº­p

---

#### TC-1.9.3: Cáº­p Nháº­t Threshold Tá»“n Kho [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Medium
**Loáº¡i:** Configuration

**Given:**
- ÄÄƒng nháº­p vá»›i vai trÃ² Admin
- Sáº£n pháº©m "iPhone 13 Pro" cÃ³ threshold = 10

**When:**
1. Nháº¥p "CÃ i Äáº·t NgÆ°á»¡ng" trÃªn sáº£n pháº©m
2. Nháº­p threshold má»›i: 15
3. Chá»n kho Ã¡p dá»¥ng: "Kho Báº£o HÃ nh"
4. Nháº¥p "LÆ°u"

**Then:**
- Báº£n ghi má»›i/cáº­p nháº­t trong `product_stock_thresholds`
- Cáº£nh bÃ¡o tá»“n kho tháº¥p cáº­p nháº­t theo threshold má»›i
- Náº¿u hiá»‡n cÃ³ 9 cÃ¡i â†’ cáº£nh bÃ¡o xuáº¥t hiá»‡n (9 < 15)

---

### Story 1.10: RMA Batch Operations

**Má»¥c tiÃªu:** Quáº£n lÃ½ lÃ´ tráº£ hÃ ng nhÃ  cung cáº¥p (RMA)

#### TC-1.10.1: Táº¡o LÃ´ RMA Má»›i [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Create Operation

**Given:**
- ÄÄƒng nháº­p vá»›i vai trÃ² Manager
- CÃ³ 5 sáº£n pháº©m hÆ° há»ng trong "Kho HÆ° Há»ng"
- Äang á»Ÿ trang /dashboard/inventory/rma

**When:**
1. Nháº¥p "Táº¡o LÃ´ RMA"
2. Äiá»n thÃ´ng tin:
   - NhÃ  cung cáº¥p: "Apple Authorized"
   - MÃ´ táº£: "Tráº£ hÃ ng lá»—i mÃ n hÃ¬nh thÃ¡ng 10/2025"
   - Loáº¡i RMA: "Warranty Return"
3. ThÃªm 5 sáº£n pháº©m:
   - Scan/nháº­p serial number
   - Nháº­p lÃ½ do tráº£ hÃ ng
4. Nháº¥p "Táº¡o LÃ´"

**Then:**
- Toast thÃ´ng bÃ¡o: "Táº¡o lÃ´ RMA thÃ nh cÃ´ng"
- Báº£n ghi má»›i trong `rma_batches`:
  - `batch_number` tá»± Ä‘á»™ng: "RMA-2025-001"
  - `status` = 'draft'
  - `total_items` = 5
- 5 báº£n ghi trong `rma_batch_items`
- Batch hiá»ƒn thá»‹ trong danh sÃ¡ch

**SQL Kiá»ƒm Tra:**
```sql
-- Kiá»ƒm tra batch
SELECT batch_number, status, total_items, created_by_id
FROM rma_batches
WHERE batch_number = 'RMA-2025-001';

-- Kiá»ƒm tra items
SELECT rbi.product_id, pp.serial_number, rbi.reason
FROM rma_batch_items rbi
JOIN physical_products pp ON pp.id = rbi.product_id
WHERE rbi.batch_id = (
  SELECT id FROM rma_batches WHERE batch_number = 'RMA-2025-001'
);
```

---

#### TC-1.10.2: Gá»­i LÃ´ RMA Cho NhÃ  Cung Cáº¥p [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Status Transition

**Given:**
- CÃ³ lÃ´ RMA "RMA-2025-001" vá»›i status = 'draft'
- LÃ´ cÃ³ 5 items

**When:**
1. Nháº¥p "Gá»­i NhÃ  Cung Cáº¥p"
2. XÃ¡c nháº­n gá»­i
3. Nháº­p tracking number (tÃ¹y chá»n): "TRACK-12345"
4. XÃ¡c nháº­n

**Then:**
- Status chuyá»ƒn thÃ nh 'sent'
- `sent_date` = now()
- `tracking_number` = "TRACK-12345"
- 5 sáº£n pháº©m tá»± Ä‘á»™ng di chuyá»ƒn sang "Kho RMA"
- Email thÃ´ng bÃ¡o gá»­i cho supplier (náº¿u cÃ³)

---

#### TC-1.10.3: Nháº­n HÃ ng Thay Tháº¿ Tá»« NhÃ  Cung Cáº¥p [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Status Transition

**Given:**
- LÃ´ RMA cÃ³ status = 'sent'
- NhÃ  cung cáº¥p gá»­i láº¡i 5 sáº£n pháº©m thay tháº¿

**When:**
1. Nháº¥p "Nháº­n HÃ ng Thay Tháº¿"
2. Scan serial number cá»§a 5 sáº£n pháº©m má»›i
3. XÃ¡c nháº­n

**Then:**
- Status chuyá»ƒn thÃ nh 'completed'
- `completed_date` = now()
- 5 sáº£n pháº©m cÅ© váº«n á»Ÿ "Kho RMA"
- 5 sáº£n pháº©m má»›i Ä‘Æ°á»£c Ä‘Äƒng kÃ½ vÃ o "Kho Báº£o HÃ nh"

---

## Phase 5: Public Portal

### Story 1.11: Public Service Request Portal

**Má»¥c tiÃªu:** Cá»•ng gá»­i yÃªu cáº§u dá»‹ch vá»¥ cÃ´ng khai (khÃ´ng cáº§n Ä‘Äƒng nháº­p)

#### TC-1.11.1: Gá»­i YÃªu Cáº§u Dá»‹ch Vá»¥ [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Public Submission

**Given:**
- KhÃ´ng Ä‘Äƒng nháº­p
- Äang á»Ÿ trang /service-request
- CÃ³ sáº£n pháº©m vá»›i serial "SN-IP13P-001"

**When:**
**BÆ°á»›c 1: XÃ¡c minh báº£o hÃ nh**
1. Nháº­p serial: "SN-IP13P-001"
2. Nháº¥p "Kiá»ƒm Tra Báº£o HÃ nh"
3. Há»‡ thá»‘ng hiá»ƒn thá»‹: "CÃ²n báº£o hÃ nh Ä‘áº¿n 15/01/2026"
4. Nháº¥p "Tiáº¿p Tá»¥c"

**BÆ°á»›c 2: ThÃ´ng tin khÃ¡ch hÃ ng**
1. Äiá»n form:
   - TÃªn: "Nguyá»…n VÄƒn A"
   - Äiá»‡n thoáº¡i: "0901234567"
   - Email: "nguyenvana@example.com"
   - Äá»‹a chá»‰: "123 Tráº§n Duy HÆ°ng, HÃ  Ná»™i"
   - MÃ´ táº£ váº¥n Ä‘á»: "MÃ n hÃ¬nh bá»‹ vá»¡ gÃ³c trÃªn bÃªn pháº£i"
   - PhÆ°Æ¡ng thá»©c giao nháº­n: "Gá»­i mÃ¡y Ä‘áº¿n trung tÃ¢m"
2. Nháº¥p "Gá»­i YÃªu Cáº§u"

**Then:**
- Redirect Ä‘áº¿n /service-request/success
- Hiá»ƒn thá»‹ tracking token: "SR-XXXXXXXXXXXX"
- NÃºt "Copy Token"
- Báº£n ghi má»›i trong `service_requests`:
  - `tracking_token` = unique 12-char string
  - `status` = 'submitted'
  - `serial_number` = "SN-IP13P-001"
  - `warranty_status` = true
  - Customer info Ä‘Æ°á»£c lÆ°u
- Email xÃ¡c nháº­n gá»­i Ä‘áº¿n customer (náº¿u cÃ³ email)

**SQL Kiá»ƒm Tra:**
```sql
SELECT tracking_token, status, customer_name, serial_number, issue_description
FROM service_requests
WHERE tracking_token = 'SR-XXXXXXXXXXXX';
```

---

#### TC-1.11.2: Validation Form ThÃ´ng Tin [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Client Validation

**Given:**
- Äang á»Ÿ bÆ°á»›c 2 cá»§a form

**When:**
1. Äá»ƒ trá»‘ng "TÃªn"
2. Nháº­p phone: "123" (quÃ¡ ngáº¯n)
3. Nháº­p email: "invalid-email"
4. Nháº¥p "Gá»­i YÃªu Cáº§u"

**Then:**
- Form khÃ´ng submit
- Hiá»ƒn thá»‹ lá»—i:
  - "TÃªn lÃ  báº¯t buá»™c"
  - "Sá»‘ Ä‘iá»‡n thoáº¡i pháº£i cÃ³ Ã­t nháº¥t 10 sá»‘"
  - "Email khÃ´ng há»£p lá»‡"
- Toast: "Vui lÃ²ng kiá»ƒm tra láº¡i thÃ´ng tin"

---

#### TC-1.11.3: Spam Protection - Honeypot [SEC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Bot Prevention

**Given:**
- Bot tá»± Ä‘á»™ng Ä‘iá»n form
- Bot Ä‘iá»n vÃ o trÆ°á»ng hidden "website" (honeypot)

**When:**
- Bot submit form vá»›i field "website" cÃ³ giÃ¡ trá»‹

**Then:**
- tRPC mutation tá»« chá»‘i request
- KhÃ´ng táº¡o service request
- KhÃ´ng cÃ³ thÃ´ng bÃ¡o lá»—i rÃµ rÃ ng (silent rejection)
- Log spam attempt

---

#### TC-1.11.4: Rate Limiting - 10 Requests Per Hour [SEC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Rate Limiting

**Given:**
- CÃ¹ng IP address Ä‘Ã£ gá»­i 10 requests trong 60 phÃºt

**When:**
- Gá»­i request thá»© 11

**Then:**
- HTTP 429 Too Many Requests
- ThÃ´ng bÃ¡o: "Báº¡n Ä‘Ã£ gá»­i quÃ¡ nhiá»u yÃªu cáº§u. Vui lÃ²ng thá»­ láº¡i sau 1 giá»."
- Request khÃ´ng Ä‘Æ°á»£c táº¡o

---

### Story 1.12: Service Request Tracking Page

**Má»¥c tiÃªu:** Theo dÃµi yÃªu cáº§u dá»‹ch vá»¥ qua tracking token

#### TC-1.12.1: Theo DÃµi YÃªu Cáº§u Báº±ng Token [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Public Query

**Given:**
- CÃ³ yÃªu cáº§u vá»›i token "SR-ABC123XYZ789"
- KhÃ´ng Ä‘Äƒng nháº­p
- Äang á»Ÿ trang /service-request/track

**When:**
1. Nháº­p token: "SR-ABC123XYZ789"
2. Nháº¥p "Theo DÃµi"

**Then:**
- Hiá»ƒn thá»‹ thÃ´ng tin yÃªu cáº§u:
  - Sá»‘ yÃªu cáº§u: "SR-ABC123XYZ789"
  - Tráº¡ng thÃ¡i: "ÄÃ£ tiáº¿p nháº­n" (badge mÃ u xanh)
  - Timeline: 4 giai Ä‘oáº¡n (Submitted, Received, Processing, Completed)
  - Giai Ä‘oáº¡n hiá»‡n táº¡i Ä‘Æ°á»£c highlight
- ThÃ´ng tin khÃ¡ch hÃ ng (Ä‘Ã£ mask):
  - TÃªn: "Nguyá»…n VÄƒn A" (hiá»ƒn thá»‹ Ä‘áº§y Ä‘á»§)
  - Email: "ngu***@example.com"
  - Phone: "****4567"
- ThÃ´ng tin sáº£n pháº©m:
  - Serial: "SN-IP13P-001"
  - Tráº¡ng thÃ¡i báº£o hÃ nh: "CÃ²n báº£o hÃ nh"
- ThÃ´ng tin phiáº¿u (náº¿u Ä‘Ã£ convert):
  - Sá»‘ phiáº¿u: "SV-2025-001"
  - Link: "/tickets/SV-2025-001" (náº¿u logged in)
- Message giai Ä‘oáº¡n hiá»‡n táº¡i:
  - "YÃªu cáº§u cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c tiáº¿p nháº­n vÃ  Ä‘ang chá» xá»­ lÃ½"
- Timestamp: "Cáº­p nháº­t láº§n cuá»‘i: 25/10/2025 14:30"

---

#### TC-1.12.2: Token KhÃ´ng Há»£p Lá»‡ [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Error Handling

**Given:**
- Token "SR-INVALID-000" khÃ´ng tá»“n táº¡i

**When:**
1. Nháº­p token: "SR-INVALID-000"
2. Nháº¥p "Theo DÃµi"

**Then:**
- Hiá»ƒn thá»‹ lá»—i: "KhÃ´ng tÃ¬m tháº¥y yÃªu cáº§u vá»›i mÃ£ nÃ y"
- Gá»£i Ã½: "Vui lÃ²ng kiá»ƒm tra láº¡i mÃ£ theo dÃµi"
- Icon âœ— (Ä‘á»)

---

#### TC-1.12.3: Auto-Refresh Má»—i 30 GiÃ¢y [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Medium
**Loáº¡i:** Real-time Updates

**Given:**
- Äang xem trang tracking
- Tab Ä‘ang active

**When:**
- Chá» 30 giÃ¢y

**Then:**
- TanStack Query tá»± Ä‘á»™ng refetch
- Tráº¡ng thÃ¡i cáº­p nháº­t náº¿u cÃ³ thay Ä‘á»•i
- Timestamp "Cáº­p nháº­t láº§n cuá»‘i" thay Ä‘á»•i
- KhÃ´ng cÃ³ full page reload

---

#### TC-1.12.4: URL Parameter Support [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Medium
**Loáº¡i:** URL Routing

**Given:**
- URL: /service-request/track?token=SR-ABC123XYZ789

**When:**
- Má»Ÿ URL

**Then:**
- Token tá»± Ä‘á»™ng Ä‘iá»n vÃ o input field
- Tá»± Ä‘á»™ng query vÃ  hiá»ƒn thá»‹ káº¿t quáº£
- Tiá»‡n cho share link tracking

---

### Story 1.13: Staff Request Management and Ticket Conversion

**Má»¥c tiÃªu:** NhÃ¢n viÃªn quáº£n lÃ½ yÃªu cáº§u vÃ  chuyá»ƒn thÃ nh phiáº¿u

#### TC-1.13.1: Xem Danh SÃ¡ch YÃªu Cáº§u Chá» Xá»­ LÃ½ [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** List View

**Given:**
- ÄÄƒng nháº­p vá»›i vai trÃ² Lá»… TÃ¢n
- CÃ³ 10 yÃªu cáº§u vá»›i status = 'submitted'
- Äang á»Ÿ trang /dashboard/service-requests

**When:**
- Trang load

**Then:**
- Hiá»ƒn thá»‹ statistics cards:
  - Tá»•ng yÃªu cáº§u: 10
  - Má»›i: 5
  - ÄÃ£ tiáº¿p nháº­n: 3
  - Äang xá»­ lÃ½: 2
  - HoÃ n thÃ nh: 0
- Báº£ng danh sÃ¡ch yÃªu cáº§u vá»›i cÃ¡c cá»™t:
  - MÃ£ tracking
  - TÃªn khÃ¡ch hÃ ng
  - Äiá»‡n thoáº¡i
  - Serial number
  - Tráº¡ng thÃ¡i
  - NgÃ y gá»­i
  - Actions (Xem, Chuyá»ƒn, Tá»« chá»‘i)
- Filter bar:
  - Tráº¡ng thÃ¡i (dropdown)
  - TÃ¬m kiáº¿m (theo tÃªn, phone, serial)

---

#### TC-1.13.2: Xem Chi Tiáº¿t YÃªu Cáº§u [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Detail View

**Given:**
- CÃ³ yÃªu cáº§u "SR-ABC123"
- ÄÄƒng nháº­p vá»›i vai trÃ² Reception

**When:**
1. Nháº¥p nÃºt "Xem" trÃªn yÃªu cáº§u
2. Modal má»Ÿ ra

**Then:**
- Hiá»ƒn thá»‹ Ä‘áº§y Ä‘á»§ thÃ´ng tin:
  - Tracking token
  - ThÃ´ng tin khÃ¡ch hÃ ng (KHÃ”NG mask - full access)
  - Serial number + warranty status
  - MÃ´ táº£ váº¥n Ä‘á»
  - PhÆ°Æ¡ng thá»©c giao nháº­n
  - NgÃ y gá»­i
  - Timeline tráº¡ng thÃ¡i
- NÃºt actions:
  - "Chuyá»ƒn ThÃ nh Phiáº¿u"
  - "Cáº­p Nháº­t Tráº¡ng ThÃ¡i"
  - "Tá»« Chá»‘i"
  - "ÄÃ³ng"

---

#### TC-1.13.3: Chuyá»ƒn YÃªu Cáº§u ThÃ nh Phiáº¿u Dá»‹ch Vá»¥ [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Conversion Operation

**Given:**
- YÃªu cáº§u "SR-ABC123" vá»›i:
  - customer_name: "Nguyá»…n VÄƒn A"
  - customer_phone: "0901234567"
  - serial_number: "SN-IP13P-001"
- ÄÄƒng nháº­p vá»›i vai trÃ² Reception

**When:**
1. Nháº¥p "Chuyá»ƒn ThÃ nh Phiáº¿u"
2. Modal conversion má»Ÿ ra vá»›i:
   - Pre-filled customer info (auto-detect or create new)
   - Pre-filled product (from serial)
   - Pre-filled issue description
3. Bá»• sung thÃ´ng tin:
   - Chá»n máº«u cÃ´ng viá»‡c: "Sá»­a Chá»¯a MÃ n HÃ¬nh"
   - Giao cho: Ká»¹ Thuáº­t ViÃªn 1
   - Æ¯u tiÃªn: "BÃ¬nh thÆ°á»ng"
4. Nháº¥p "Táº¡o Phiáº¿u"

**Then:**
- Toast thÃ´ng bÃ¡o: "Chuyá»ƒn Ä‘á»•i thÃ nh cÃ´ng! Phiáº¿u SV-2025-XXX Ä‘Ã£ Ä‘Æ°á»£c táº¡o"
- Phiáº¿u má»›i Ä‘Æ°á»£c táº¡o:
  - Ticket number: SV-2025-XXX (auto-generated)
  - Customer: Nguyá»…n VÄƒn A (existing or newly created)
  - Product: iPhone 13 Pro (from serial)
  - Issue: From request description
  - Template: "Sá»­a Chá»¯a MÃ n HÃ¬nh"
  - Assigned to: Ká»¹ Thuáº­t ViÃªn 1
  - Status: "pending"
- Service request cáº­p nháº­t:
  - `status` = 'converted'
  - `converted_to_ticket_id` = new ticket id
  - `converted_at` = now()
  - `converted_by_id` = current user id
- CÃ´ng viá»‡c tá»± Ä‘á»™ng táº¡o (tá»« template)
- Email thÃ´ng bÃ¡o gá»­i cho customer: "YÃªu cáº§u Ä‘Ã£ Ä‘Æ°á»£c chuyá»ƒn thÃ nh phiáº¿u SV-2025-XXX"

**SQL Kiá»ƒm Tra:**
```sql
-- Kiá»ƒm tra request Ä‘Ã£ convert
SELECT status, converted_to_ticket_id, converted_at
FROM service_requests
WHERE tracking_token = 'SR-ABC123';

-- Kiá»ƒm tra ticket má»›i
SELECT ticket_number, customer_id, product_id, status
FROM service_tickets
WHERE id = (
  SELECT converted_to_ticket_id FROM service_requests
  WHERE tracking_token = 'SR-ABC123'
);
```

---

#### TC-1.13.4: Tá»± Äá»™ng Táº¡o KhÃ¡ch HÃ ng Má»›i Náº¿u ChÆ°a Tá»“n Táº¡i [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Auto Customer Creation

**Given:**
- YÃªu cáº§u tá»« khÃ¡ch hÃ ng má»›i (phone chÆ°a cÃ³ trong database)
- customer_phone: "0999999999"

**When:**
- Chuyá»ƒn Ä‘á»•i request thÃ nh ticket

**Then:**
- Tá»± Ä‘á»™ng táº¡o customer má»›i:
  - name tá»« request.customer_name
  - phone tá»« request.customer_phone
  - email tá»« request.customer_email
  - address tá»« request.customer_address
- Ticket Ä‘Æ°á»£c táº¡o vá»›i customer má»›i
- KhÃ´ng cáº§n nháº­p thÃ´ng tin customer thá»§ cÃ´ng

---

#### TC-1.13.5: Tá»« Chá»‘i YÃªu Cáº§u Vá»›i LÃ½ Do [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Medium
**Loáº¡i:** Rejection

**Given:**
- YÃªu cáº§u "SR-ABC123"
- ÄÄƒng nháº­p vá»›i vai trÃ² Manager

**When:**
1. Nháº¥p "Tá»« Chá»‘i"
2. Dialog má»Ÿ ra
3. Chá»n lÃ½ do:
   - "Sáº£n pháº©m háº¿t báº£o hÃ nh"
   - "KhÃ´ng há»— trá»£ sáº£n pháº©m nÃ y"
   - "ThÃ´ng tin khÃ´ng Ä‘áº§y Ä‘á»§"
   - "KhÃ¡c" (nháº­p lÃ½ do tÃ¹y chá»‰nh)
4. Nháº­p lÃ½ do: "Sáº£n pháº©m khÃ´ng náº±m trong chÃ­nh sÃ¡ch báº£o hÃ nh"
5. Nháº¥p "XÃ¡c Nháº­n Tá»« Chá»‘i"

**Then:**
- status = 'cancelled'
- `cancellation_reason` Ä‘Æ°á»£c lÆ°u
- `reviewed_by_id` = current user ID
- `reviewed_at` = now()
- Email thÃ´ng bÃ¡o gá»­i cho customer vá»›i lÃ½ do tá»« chá»‘i

---

#### TC-1.13.6: Badge Sá»‘ LÆ°á»£ng YÃªu Cáº§u Chá» Xá»­ LÃ½ [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Medium
**Loáº¡i:** UI Notification

**Given:**
- CÃ³ 7 yÃªu cáº§u chÆ°a xá»­ lÃ½ (status = submitted)
- ÄÄƒng nháº­p vá»›i vai trÃ² Reception

**When:**
- Xem sidebar navigation

**Then:**
- Link "YÃªu cáº§u dá»‹ch vá»¥" hiá»ƒn thá»‹ badge sá»‘: "7"
- Badge mÃ u Ä‘á» ná»•i báº­t
- Auto-refresh má»—i 30 giÃ¢y
- Badge biáº¿n máº¥t khi count = 0

---

### Story 1.14: Customer Delivery Confirmation Workflow

**Má»¥c tiÃªu:** XÃ¡c nháº­n giao hÃ ng cho khÃ¡ch

#### TC-1.14.1: XÃ¡c Nháº­n Giao HÃ ng [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Delivery Confirmation

**Given:**
- Phiáº¿u "SV-2025-001" cÃ³ status = "completed"
- Phiáº¿u chÆ°a Ä‘Æ°á»£c xÃ¡c nháº­n giao hÃ ng
- ÄÄƒng nháº­p vá»›i vai trÃ² Manager

**When:**
1. Má»Ÿ trang chi tiáº¿t phiáº¿u
2. Nháº¥p "XÃ¡c Nháº­n Giao HÃ ng"
3. Modal má»Ÿ ra:
   - PhÆ°Æ¡ng thá»©c: "KhÃ¡ch Ä‘áº¿n láº¥y" / "Giao hÃ ng táº­n nÆ¡i"
   - NgÆ°á»i nháº­n: "Nguyá»…n VÄƒn A"
   - Chá»¯ kÃ½: Canvas Ä‘á»ƒ khÃ¡ch kÃ½
   - Ghi chÃº: "KhÃ¡ch hÃ i lÃ²ng vá»›i dá»‹ch vá»¥"
4. KhÃ¡ch kÃ½ trÃªn canvas
5. Nháº¥p "XÃ¡c Nháº­n"

**Then:**
- Toast thÃ´ng bÃ¡o: "XÃ¡c nháº­n giao hÃ ng thÃ nh cÃ´ng"
- Database updates:
  - `delivery_confirmed` = true
  - `delivery_confirmed_at` = now()
  - `delivery_confirmed_by_id` = current user
  - `delivery_method` = "pickup" / "delivery"
  - `delivery_recipient_name` = "Nguyá»…n VÄƒn A"
  - `delivery_signature_url` = URL to signature image
  - `delivery_notes` = "KhÃ¡ch hÃ i lÃ²ng..."
- Chá»¯ kÃ½ Ä‘Æ°á»£c upload lÃªn Supabase Storage bucket `signatures`
- Email xÃ¡c nháº­n giao hÃ ng gá»­i cho customer
- Phiáº¿u hiá»ƒn thá»‹ section "ThÃ´ng tin giao hÃ ng" vá»›i:
  - NgÃ y giao: 25/10/2025 15:30
  - NgÆ°á»i xÃ¡c nháº­n: Manager Test
  - PhÆ°Æ¡ng thá»©c: KhÃ¡ch Ä‘áº¿n láº¥y
  - NgÆ°á»i nháº­n: Nguyá»…n VÄƒn A
  - Chá»¯ kÃ½ (áº£nh)
  - Ghi chÃº

**SQL Kiá»ƒm Tra:**
```sql
SELECT
  delivery_confirmed, delivery_confirmed_at,
  delivery_method, delivery_recipient_name,
  delivery_signature_url, delivery_notes
FROM service_tickets
WHERE ticket_number = 'SV-2025-001';
```

---

#### TC-1.14.2: Danh SÃ¡ch Phiáº¿u Chá» Giao HÃ ng [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** List View

**Given:**
- CÃ³ 5 phiáº¿u completed chÆ°a xÃ¡c nháº­n giao hÃ ng
- ÄÄƒng nháº­p vá»›i vai trÃ² Manager
- Äang á»Ÿ trang /dashboard/deliveries

**When:**
- Trang load

**Then:**
- Hiá»ƒn thá»‹ báº£ng 5 phiáº¿u vá»›i cÃ¡c cá»™t:
  - Sá»‘ phiáº¿u
  - KhÃ¡ch hÃ ng
  - Sáº£n pháº©m
  - NgÃ y hoÃ n thÃ nh
  - Actions (XÃ¡c nháº­n giao hÃ ng)
- Badge sá»‘ lÆ°á»£ng á»Ÿ sidebar: "5"
- Auto-refresh má»—i 30 giÃ¢y

---

#### TC-1.14.3: Signature Canvas - Váº½ Báº±ng Chuá»™t [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Signature Capture

**Given:**
- Modal xÃ¡c nháº­n giao hÃ ng Ä‘ang má»Ÿ
- Canvas signature component hiá»ƒn thá»‹

**When:**
1. Click vÃ  kÃ©o chuá»™t trÃªn canvas
2. Váº½ chá»¯ kÃ½ "Nguyá»…n VÄƒn A"
3. Release chuá»™t

**Then:**
- ÄÆ°á»ng nÃ©t Ä‘Æ°á»£c váº½ lÃªn canvas
- NÃºt "XÃ³a chá»¯ kÃ½" kháº£ dá»¥ng
- Preview chá»¯ kÃ½ hiá»ƒn thá»‹
- Canvas convert to PNG khi submit

---

#### TC-1.14.4: Signature Canvas - Váº½ Báº±ng Touch [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Medium
**Loáº¡i:** Touch Support

**Given:**
- Sá»­ dá»¥ng thiáº¿t bá»‹ touch (tablet, smartphone)
- Modal xÃ¡c nháº­n giao hÃ ng Ä‘ang má»Ÿ

**When:**
- Touch vÃ  kÃ©o ngÃ³n tay trÃªn canvas

**Then:**
- ÄÆ°á»ng nÃ©t Ä‘Æ°á»£c váº½ smooth
- KhÃ´ng cÃ³ scroll khi váº½
- Há»— trá»£ multi-touch (prevent default)

---

#### TC-1.14.5: Validation - Báº¯t Buá»™c Chá»¯ KÃ½ [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Validation

**Given:**
- Modal xÃ¡c nháº­n giao hÃ ng Ä‘ang má»Ÿ
- Canvas trá»‘ng (chÆ°a cÃ³ chá»¯ kÃ½)

**When:**
- Nháº¥p "XÃ¡c Nháº­n" mÃ  chÆ°a kÃ½

**Then:**
- Hiá»ƒn thá»‹ lá»—i: "Vui lÃ²ng kÃ½ xÃ¡c nháº­n trÆ°á»›c khi gá»­i"
- Modal khÃ´ng Ä‘Ã³ng
- KhÃ´ng cáº­p nháº­t database

---

## Phase 6: Enhanced Features

### Story 1.15: Email Notification System

**Má»¥c tiÃªu:** Há»‡ thá»‘ng thÃ´ng bÃ¡o email tá»± Ä‘á»™ng

#### TC-1.15.1: Email Khi Gá»­i YÃªu Cáº§u Dá»‹ch Vá»¥ [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Email Trigger

**Given:**
- KhÃ¡ch hÃ ng gá»­i yÃªu cáº§u má»›i
- Email: "customer@example.com"

**When:**
- Request Ä‘Æ°á»£c táº¡o thÃ nh cÃ´ng

**Then:**
- Email Ä‘Æ°á»£c queue trong `email_notifications`:
  - `email_type` = 'request_submitted'
  - `recipient_email` = "customer@example.com"
  - `status` = 'pending'
- Email content bao gá»“m:
  - Subject: "YÃªu cáº§u dá»‹ch vá»¥ cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c gá»­i"
  - Tracking token: SR-ABC123
  - Link theo dÃµi: /service-request/track?token=SR-ABC123
  - ThÃ´ng tin yÃªu cáº§u
  - Unsubscribe link
- Email Ä‘Æ°á»£c gá»­i (hoáº·c log náº¿u dev mode)
- Status cáº­p nháº­t: 'sent' hoáº·c 'failed'

**SQL Kiá»ƒm Tra:**
```sql
SELECT email_type, recipient_email, status, sent_at
FROM email_notifications
WHERE request_id = 'request_id_here'
AND email_type = 'request_submitted';
```

---

#### TC-1.15.2: Email Khi Chuyá»ƒn Äá»•i ThÃ nh Phiáº¿u [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Email Trigger

**Given:**
- YÃªu cáº§u Ä‘Æ°á»£c chuyá»ƒn thÃ nh phiáº¿u "SV-2025-001"

**When:**
- Conversion thÃ nh cÃ´ng

**Then:**
- Email type = 'ticket_created'
- Content:
  - Subject: "YÃªu cáº§u cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c chuyá»ƒn thÃ nh phiáº¿u dá»‹ch vá»¥"
  - Sá»‘ phiáº¿u: SV-2025-001
  - Ká»¹ thuáº­t viÃªn Ä‘Æ°á»£c giao
  - Thá»i gian Æ°á»›c tÃ­nh
  - Unsubscribe link

---

#### TC-1.15.3: Email Khi Phiáº¿u HoÃ n ThÃ nh [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Email Trigger

**Given:**
- Phiáº¿u "SV-2025-001" chuyá»ƒn status â†’ "completed"

**When:**
- Status update thÃ nh cÃ´ng

**Then:**
- Email type = 'service_completed'
- Content:
  - Subject: "Dá»‹ch vá»¥ cá»§a báº¡n Ä‘Ã£ hoÃ n thÃ nh"
  - Sá»‘ phiáº¿u
  - ThÃ´ng tin Ä‘á»ƒ Ä‘áº¿n láº¥y mÃ¡y
  - Giá» lÃ m viá»‡c trung tÃ¢m

---

#### TC-1.15.4: Email Khi XÃ¡c Nháº­n Giao HÃ ng [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Email Trigger

**Given:**
- Delivery Ä‘Æ°á»£c xÃ¡c nháº­n

**When:**
- Confirmation thÃ nh cÃ´ng

**Then:**
- Email type = 'delivery_confirmed'
- Content:
  - Subject: "XÃ¡c nháº­n giao hÃ ng thÃ nh cÃ´ng"
  - ThÃ´ng tin giao hÃ ng
  - Lá»i cáº£m Æ¡n

---

#### TC-1.15.5: Unsubscribe Functionality [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Email Preference

**Given:**
- Customer nháº­n email
- Email cÃ³ link: /unsubscribe?email=customer@example.com&type=service_completed

**When:**
1. Click link unsubscribe
2. Trang /unsubscribe má»Ÿ ra
3. Checkbox Ä‘á»ƒ chá»n loáº¡i email muá»‘n há»§y:
   - â˜‘ Email khi yÃªu cáº§u Ä‘Æ°á»£c tiáº¿p nháº­n
   - â˜‘ Email khi dá»‹ch vá»¥ hoÃ n thÃ nh
   - â˜ Email khi giao hÃ ng
4. Nháº¥p "Cáº­p Nháº­t CÃ i Äáº·t"

**Then:**
- Customer.email_preferences Ä‘Æ°á»£c cáº­p nháº­t:
  ```json
  {
    "request_received": false,
    "service_completed": false,
    "delivery_confirmed": true
  }
  ```
- ThÃ´ng bÃ¡o: "CÃ i Ä‘áº·t email cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t"
- CÃ¡c email loáº¡i 'request_received' vÃ  'service_completed' sáº½ KHÃ”NG gá»­i cho customer nÃ y
- Email 'delivery_confirmed' váº«n gá»­i bÃ¬nh thÆ°á»ng

---

#### TC-1.15.6: Admin Xem Log Email [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Medium
**Loáº¡i:** Admin Dashboard

**Given:**
- ÄÄƒng nháº­p vá»›i vai trÃ² Admin
- CÃ³ 100 email Ä‘Ã£ gá»­i
- Äang á»Ÿ trang /dashboard/notifications

**When:**
- Trang load

**Then:**
- Statistics cards:
  - Tá»•ng email: 100
  - ÄÃ£ gá»­i: 85
  - Tháº¥t báº¡i: 10
  - Äang chá»: 5
- Báº£ng email log vá»›i columns:
  - Loáº¡i email (badge mÃ u)
  - NgÆ°á»i nháº­n
  - Tráº¡ng thÃ¡i (sent/failed/pending)
  - NgÃ y gá»­i
  - Actions (Xem, Retry)
- Filters:
  - Loáº¡i email (dropdown)
  - Tráº¡ng thÃ¡i (dropdown)
  - TÃ¬m kiáº¿m email
- Pagination: 50/page

---

#### TC-1.15.7: Admin Retry Failed Email [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Medium
**Loáº¡i:** Retry Mechanism

**Given:**
- Email cÃ³ status = 'failed'
- Error message: "SMTP connection timeout"

**When:**
1. Admin nháº¥p "Thá»­ Láº¡i"
2. XÃ¡c nháº­n

**Then:**
- Email Ä‘Æ°á»£c queue láº¡i
- Status â†’ 'pending'
- `retry_count` tÄƒng lÃªn
- Email Ä‘Æ°á»£c gá»­i láº¡i
- Náº¿u thÃ nh cÃ´ng: status â†’ 'sent'
- Náº¿u tháº¥t báº¡i: status â†’ 'failed', retry_count++
- Max retry: 3 láº§n

---

#### TC-1.15.8: Rate Limiting - 100 Emails Per 24h Per Customer [SEC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Rate Limiting

**Given:**
- Customer "customer@example.com" Ä‘Ã£ nháº­n 100 emails trong 24h

**When:**
- Há»‡ thá»‘ng cá»‘ gáº¯ng gá»­i email thá»© 101

**Then:**
- Email KHÃ”NG Ä‘Æ°á»£c queue
- Log warning: "Rate limit exceeded for customer@example.com"
- Admin nháº­n thÃ´ng bÃ¡o (náº¿u cÃ³ monitoring)

---

### Story 1.16: Manager Task Progress Dashboard

**Má»¥c tiÃªu:** Báº£ng Ä‘iá»u khiá»ƒn tiáº¿n Ä‘á»™ cÃ´ng viá»‡c cho Quáº£n LÃ½

#### TC-1.16.1: Xem Metrics Tá»•ng Quan [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Dashboard View

**Given:**
- CÃ³ 20 phiáº¿u active
- 50 cÃ´ng viá»‡c Ä‘ang xá»­ lÃ½
- 5 cÃ´ng viá»‡c bá»‹ cháº·n
- ÄÄƒng nháº­p vá»›i vai trÃ² Manager
- Äang á»Ÿ trang /dashboard/task-progress

**When:**
- Trang load

**Then:**
- 4 Metrics cards hiá»ƒn thá»‹:
  1. **Phiáº¿u Hoáº¡t Äá»™ng**: 20
     - Icon: ğŸ“‹
  2. **CÃ´ng Viá»‡c Äang Xá»­ LÃ½**: 50
     - Subtitle: "(12 chá» xá»­ lÃ½)"
     - Icon: â³
  3. **CÃ´ng Viá»‡c Bá»‹ Cháº·n**: 5
     - MÃ u Ä‘á» náº¿u > 0
     - Icon: ğŸš«
  4. **Thá»i Gian HoÃ n ThÃ nh TB**: 45 phÃºt
     - Subtitle: "(120 cÃ´ng viá»‡c Ä‘Ã£ xong)"
     - Icon: â±ï¸
- Dá»¯ liá»‡u tá»« view `v_task_progress_summary`
- Auto-refresh má»—i 30 giÃ¢y

---

#### TC-1.16.2: Xem Danh SÃ¡ch Phiáº¿u CÃ³ Task Bá»‹ Cháº·n [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Alert List

**Given:**
- Phiáº¿u "SV-2025-001" cÃ³ 1 task blocked
- Phiáº¿u "SV-2025-005" cÃ³ 2 tasks blocked
- CÃ¡c phiáº¿u khÃ¡c khÃ´ng cÃ³ task blocked

**When:**
- Xem trang dashboard

**Then:**
- Section "Cáº£nh BÃ¡o CÃ´ng Viá»‡c Bá»‹ Cháº·n":
  - Náº¿u cÃ³ blocked tasks:
    - Alert mÃ u Ä‘á»
    - TiÃªu Ä‘á»: "âš ï¸ CÃ³ 2 phiáº¿u vá»›i cÃ´ng viá»‡c bá»‹ cháº·n"
    - Danh sÃ¡ch:
      - SV-2025-001 (1 cÃ´ng viá»‡c bá»‹ cháº·n)
      - SV-2025-005 (2 cÃ´ng viá»‡c bá»‹ cháº·n)
    - Link Ä‘áº¿n tá»«ng phiáº¿u
  - Náº¿u khÃ´ng cÃ³:
    - Alert mÃ u xanh
    - "âœ“ KhÃ´ng cÃ³ cÃ´ng viá»‡c bá»‹ cháº·n"

---

#### TC-1.16.3: Xem Báº£ng Khá»‘i LÆ°á»£ng CÃ´ng Viá»‡c Ká»¹ Thuáº­t ViÃªn [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Workload Table

**Given:**
- Ká»¹ Thuáº­t ViÃªn 1:
  - Tá»•ng tasks: 25
  - Äang xá»­ lÃ½: 5
  - Chá» xá»­ lÃ½: 10
  - HoÃ n thÃ nh: 9
  - Bá»‹ cháº·n: 1
- Ká»¹ Thuáº­t ViÃªn 2:
  - Tá»•ng tasks: 15
  - Äang xá»­ lÃ½: 3
  - Chá» xá»­ lÃ½: 5
  - HoÃ n thÃ nh: 7
  - Bá»‹ cháº·n: 0

**When:**
- Xem section "Khá»‘i LÆ°á»£ng CÃ´ng Viá»‡c Ká»¹ Thuáº­t ViÃªn"

**Then:**
- Báº£ng hiá»ƒn thá»‹ 2 hÃ ng:

| Ká»¹ Thuáº­t ViÃªn | Äang Xá»­ LÃ½ | Chá» Xá»­ LÃ½ | HoÃ n ThÃ nh | Bá»‹ Cháº·n | Tá»· Lá»‡ HoÃ n ThÃ nh |
|---------------|------------|-----------|------------|---------|------------------|
| Ká»¹ Thuáº­t ViÃªn 1 | 5 (badge) | 10 | 9 | 1 (Ä‘á») | 36% (9/25) |
| Ká»¹ Thuáº­t ViÃªn 2 | 3 (badge) | 5 | 7 | 0 | 47% (7/15) |

- Sáº¯p xáº¿p theo tá»•ng tasks (nhiá»u nháº¥t trÆ°á»›c)
- Badge mÃ u theo tráº¡ng thÃ¡i
- Tá»· lá»‡ hoÃ n thÃ nh = (completed / total) * 100%

---

#### TC-1.16.4: Filter Theo Ká»¹ Thuáº­t ViÃªn [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Medium
**Loáº¡i:** Filtering

**Given:**
- Dashboard Ä‘ang hiá»ƒn thá»‹ táº¥t cáº£ ká»¹ thuáº­t viÃªn

**When:**
1. Select dropdown "Ká»¹ Thuáº­t ViÃªn"
2. Chá»n "Ká»¹ Thuáº­t ViÃªn 1"

**Then:**
- Metrics cards cáº­p nháº­t:
  - Chá»‰ hiá»ƒn thá»‹ sá»‘ liá»‡u cá»§a KTV 1
- Báº£ng workload:
  - Chá»‰ hiá»ƒn thá»‹ 1 hÃ ng (KTV 1)
- URL update: ?technician=tech1_id

---

#### TC-1.16.5: Auto-Refresh Dashboard [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Medium
**Loáº¡i:** Real-time Updates

**Given:**
- Dashboard Ä‘ang má»Ÿ
- Tab active

**When:**
- Chá» 30 giÃ¢y

**Then:**
- TanStack Query refetch:
  - Task progress summary
  - Blocked tasks
  - Technician workload
- Metrics cards cáº­p nháº­t
- Báº£ng workload cáº­p nháº­t
- KhÃ´ng cÃ³ full page reload

---

### Story 1.17: Dynamic Template Switching

**Má»¥c tiÃªu:** Chuyá»ƒn Ä‘á»•i máº«u cÃ´ng viá»‡c giá»¯a dá»‹ch vá»¥

#### TC-1.17.1: Chuyá»ƒn Äá»•i Máº«u Giá»¯a Dá»‹ch Vá»¥ [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Template Switch

**Given:**
- Phiáº¿u "SV-2025-001":
  - Template hiá»‡n táº¡i: "Sá»­a MÃ n HÃ¬nh" (5 tasks)
  - Tasks: 2 completed, 1 in_progress, 2 pending
  - Status: "in_progress"
- ÄÄƒng nháº­p vá»›i vai trÃ² Ká»¹ Thuáº­t ViÃªn
- Äang á»Ÿ trang chi tiáº¿t phiáº¿u

**When:**
1. Nháº¥p "Äá»•i Máº«u"
2. Modal má»Ÿ ra
3. Chá»n máº«u má»›i: "Sá»­a Chá»¯a Bo Máº¡ch" (7 tasks)
4. Preview máº«u má»›i:
   - 7 tasks Ä‘Æ°á»£c liá»‡t kÃª
   - Cáº£nh bÃ¡o: "2 cÃ´ng viá»‡c Ä‘Ã£ hoÃ n thÃ nh sáº½ Ä‘Æ°á»£c giá»¯ láº¡i"
   - "3 cÃ´ng viá»‡c má»›i sáº½ Ä‘Æ°á»£c thÃªm vÃ o"
5. Nháº­p lÃ½ do (min 10 chars):
   "Cháº©n Ä‘oÃ¡n phÃ¡t hiá»‡n lá»—i bo máº¡ch thay vÃ¬ mÃ n hÃ¬nh. Cáº§n thay Ä‘á»•i quy trÃ¬nh sá»­a chá»¯a."
6. Nháº¥p "XÃ¡c Nháº­n Äá»•i Máº«u"

**Then:**
- Toast thÃ´ng bÃ¡o: "ÄÃ£ chuyá»ƒn template thÃ nh cÃ´ng! 2 cÃ´ng viá»‡c giá»¯ láº¡i, 3 cÃ´ng viá»‡c má»›i Ä‘Æ°á»£c thÃªm."
- Database updates:
  - `service_tickets.template_id` = new template id
  - `service_ticket_tasks`:
    - 2 completed tasks: GIá»® NGUYÃŠN
    - 1 in_progress task: GIá»® NGUYÃŠN
    - 2 pending tasks: Bá»Š XÃ“A
    - 3 new tasks: ÄÆ¯á»¢C THÃŠM (status = pending)
  - Tá»•ng tasks sau switch: 6 (3 giá»¯ + 3 má»›i)
  - Sequence order Ä‘Æ°á»£c tÃ¡i Ä‘Ã¡nh sá»‘: 1-6
- Audit trail trong `ticket_template_changes`:
  - old_template_id, new_template_id
  - reason = "Cháº©n Ä‘oÃ¡n phÃ¡t hiá»‡n..."
  - tasks_preserved_count = 3
  - tasks_added_count = 3
  - changed_by_id = technician id
  - changed_at = now()
- Trang reload/refresh vá»›i danh sÃ¡ch tasks má»›i

**SQL Kiá»ƒm Tra:**
```sql
-- Kiá»ƒm tra template Ä‘Ã£ Ä‘á»•i
SELECT template_id FROM service_tickets WHERE ticket_number = 'SV-2025-001';

-- Kiá»ƒm tra tasks sau switch
SELECT sequence_order, task_type_id, status
FROM service_ticket_tasks
WHERE ticket_id = (SELECT id FROM service_tickets WHERE ticket_number = 'SV-2025-001')
ORDER BY sequence_order;

-- Kiá»ƒm tra audit trail
SELECT old_template_id, new_template_id, reason, tasks_preserved_count, tasks_added_count
FROM ticket_template_changes
WHERE ticket_id = (SELECT id FROM service_tickets WHERE ticket_number = 'SV-2025-001');
```

---

#### TC-1.17.2: Validation - KhÃ´ng Äá»•i Template Phiáº¿u HoÃ n ThÃ nh [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Validation

**Given:**
- Phiáº¿u cÃ³ status = "completed"

**When:**
- Thá»­ nháº¥p "Äá»•i Máº«u"

**Then:**
- NÃºt "Äá»•i Máº«u" KHÃ”NG hiá»ƒn thá»‹
- Hoáº·c náº¿u gá»i trá»±c tiáº¿p tRPC mutation:
  - TRPCError: "KhÃ´ng thá»ƒ Ä‘á»•i máº«u cho phiáº¿u Ä‘Ã£ hoÃ n thÃ nh"

---

#### TC-1.17.3: Validation - KhÃ´ng Äá»•i Náº¿u Táº¥t Cáº£ Tasks ÄÃ£ Xong [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Validation

**Given:**
- Phiáº¿u cÃ³ status = "in_progress"
- Táº¥t cáº£ tasks cÃ³ status = "completed"

**When:**
- Thá»­ Ä‘á»•i máº«u

**Then:**
- Lá»—i: "Táº¥t cáº£ cÃ´ng viá»‡c Ä‘Ã£ hoÃ n thÃ nh. KhÃ´ng thá»ƒ Ä‘á»•i máº«u."
- Gá»£i Ã½: "Vui lÃ²ng hoÃ n thÃ nh phiáº¿u thay vÃ¬ Ä‘á»•i máº«u."

---

#### TC-1.17.4: Smart Task Merging - KhÃ´ng TrÃ¹ng Láº·p [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** High
**Loáº¡i:** Business Logic

**Given:**
- Máº«u cÅ© cÃ³ tasks: A, B, C, D, E
- Tasks A, B: completed
- Máº«u má»›i cÃ³ tasks: A, B, F, G, H

**When:**
- Switch template

**Then:**
- Tasks Ä‘Æ°á»£c giá»¯:
  - A (completed) - giá»¯ láº¡i
  - B (completed) - giá»¯ láº¡i
- Tasks má»›i Ä‘Æ°á»£c thÃªm:
  - F, G, H (KHÃ”NG thÃªm A, B vÃ¬ Ä‘Ã£ tá»“n táº¡i)
- Tá»•ng tasks sau switch: 5 (A, B, F, G, H)
- Logic: Chá»‰ thÃªm tasks cÃ³ `task_type_id` chÆ°a tá»“n táº¡i

---

#### TC-1.17.5: Xem Lá»‹ch Sá»­ Äá»•i Template [FUNC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Medium
**Loáº¡i:** Audit Trail View

**Given:**
- Phiáº¿u Ä‘Ã£ Ä‘á»•i template 2 láº§n
- Äang á»Ÿ trang chi tiáº¿t phiáº¿u

**When:**
- Scroll xuá»‘ng section "Lá»‹ch Sá»­ Äá»•i Máº«u"

**Then:**
- Timeline hiá»ƒn thá»‹ 2 láº§n Ä‘á»•i:

**Láº§n 1:**
- Thá»i gian: 25/10/2025 10:00
- Tá»«: "Sá»­a MÃ n HÃ¬nh" â†’ "Sá»­a Bo Máº¡ch"
- LÃ½ do: "Cháº©n Ä‘oÃ¡n phÃ¡t hiá»‡n lá»—i bo máº¡ch..."
- NgÆ°á»i Ä‘á»•i: Ká»¹ Thuáº­t ViÃªn 1
- CÃ´ng viá»‡c: 2 giá»¯ láº¡i, 3 thÃªm má»›i

**Láº§n 2:**
- Thá»i gian: 25/10/2025 14:00
- Tá»«: "Sá»­a Bo Máº¡ch" â†’ "Thay Linh Kiá»‡n"
- LÃ½ do: "Bo máº¡ch khÃ´ng sá»­a Ä‘Æ°á»£c, cáº§n thay hoÃ n toÃ n"
- NgÆ°á»i Ä‘á»•i: Ká»¹ Thuáº­t ViÃªn 1
- CÃ´ng viá»‡c: 3 giá»¯ láº¡i, 2 thÃªm má»›i

---

#### TC-1.17.6: Permission - Chá»‰ Technician/Manager/Admin [SEC]

**Má»©c Äá»™ Æ¯u TiÃªn:** Critical
**Loáº¡i:** Authorization

**Given:**
- ÄÄƒng nháº­p vá»›i vai trÃ² Reception

**When:**
- Xem trang chi tiáº¿t phiáº¿u

**Then:**
- NÃºt "Äá»•i Máº«u" KHÃ”NG hiá»ƒn thá»‹
- Náº¿u gá»i trá»±c tiáº¿p tRPC:
  - TRPCError: "KhÃ´ng cÃ³ quyá»n thá»±c hiá»‡n thao tÃ¡c nÃ y"

---

## Ma Tráº­n Truy Xuáº¥t

### Báº£ng Ãnh Xáº¡ Test Cases â†’ Acceptance Criteria

| Story | Test Case ID | Acceptance Criteria | Priority |
|-------|-------------|---------------------|----------|
| 1.1 | TC-1.1.1, TC-1.1.2, TC-1.1.3, TC-1.1.4 | AC1-AC8 (Foundation setup) | Critical |
| 1.2 | TC-1.2.1, TC-1.2.2, TC-1.2.3, TC-1.2.4, TC-1.2.5, TC-1.2.6 | AC1-AC7 (Template CRUD) | Critical |
| 1.3 | TC-1.3.1, TC-1.3.2, TC-1.3.3 | AC1-AC5 (Auto task generation) | Critical |
| 1.4 | TC-1.4.1 thru TC-1.4.8 | AC1-AC8 (Task execution UI) | Critical |
| 1.5 | TC-1.5.1 thru TC-1.5.6 | AC1-AC6 (Dependencies & automation) | Critical |
| 1.6 | TC-1.6.1, TC-1.6.2, TC-1.6.3 | AC1-AC4 (Warehouse setup) | High |
| 1.7 | TC-1.7.1 thru TC-1.7.4 | AC1-AC5 (Product master data) | High |
| 1.8 | TC-1.8.1 thru TC-1.8.4 | AC1-AC6 (Serial & stock movements) | Critical |
| 1.9 | TC-1.9.1, TC-1.9.2, TC-1.9.3 | AC1-AC4 (Stock levels & alerts) | High |
| 1.10 | TC-1.10.1, TC-1.10.2, TC-1.10.3 | AC1-AC5 (RMA operations) | High |
| 1.11 | TC-1.11.1 thru TC-1.11.4 | AC1-AC12 (Public portal) | Critical |
| 1.12 | TC-1.12.1 thru TC-1.12.4 | AC1-AC11 (Request tracking) | Critical |
| 1.13 | TC-1.13.1 thru TC-1.13.6 | AC1-AC10 (Staff request mgmt) | Critical |
| 1.14 | TC-1.14.1 thru TC-1.14.5 | AC1-AC7 (Delivery confirmation) | High |
| 1.15 | TC-1.15.1 thru TC-1.15.8 | AC1-AC9 (Email notifications) | Critical |
| 1.16 | TC-1.16.1 thru TC-1.16.5 | AC1-AC8 (Manager dashboard) | High |
| 1.17 | TC-1.17.1 thru TC-1.17.6 | AC1-AC10 (Dynamic template switch) | Critical |

### Äá»™ Bao Phá»§ Theo Loáº¡i Kiá»ƒm Thá»­

| Loáº¡i | Sá»‘ LÆ°á»£ng Test Cases | Pháº§n TrÄƒm |
|------|---------------------|-----------|
| [FUNC] - Functional | 75 | 68% |
| [SEC] - Security | 15 | 14% |
| [INT] - Integration | 8 | 7% |
| [PERF] - Performance | 6 | 5% |
| [E2E] - End-to-End | 6 | 5% |
| **Tá»•ng** | **110** | **100%** |

### Äá»™ Bao Phá»§ Theo Má»©c Äá»™ Æ¯u TiÃªn

| Má»©c Äá»™ | Sá»‘ LÆ°á»£ng | Pháº§n TrÄƒm |
|--------|----------|-----------|
| Critical | 45 | 41% |
| High | 38 | 35% |
| Medium | 27 | 24% |
| **Tá»•ng** | **110** | **100%** |

---

## Ghi ChÃº Thá»±c Hiá»‡n

### MÃ´i TrÆ°á»ng Kiá»ƒm Thá»­

```bash
# Setup mÃ´i trÆ°á»ng
pnpx supabase start
pnpm dev

# Seed dá»¯ liá»‡u test
psql -h localhost -p 54322 -U postgres -f test-data.sql

# Cháº¡y migrations
pnpx supabase db reset
```

### CÃ´ng Cá»¥ Há»— Trá»£

- **Supabase Studio**: http://localhost:54323 - Kiá»ƒm tra database
- **tRPC Panel**: /api/panel - Test API endpoints
- **Chrome DevTools**: Network tab - Monitor requests
- **React DevTools**: Component inspection

### Checklist TrÆ°á»›c Khi Kiá»ƒm Thá»­

- [ ] Database migrations Ä‘Ã£ apply
- [ ] Seed data Ä‘Ã£ load
- [ ] Dev server Ä‘ang cháº¡y
- [ ] Test users Ä‘Ã£ táº¡o
- [ ] Supabase services Ä‘ang hoáº¡t Ä‘á»™ng

---

**TÃ i Liá»‡u NÃ y Bao Gá»“m:**
- 110 test cases chi tiáº¿t
- Given-When-Then format
- SQL queries kiá»ƒm tra
- Validation scenarios
- Security test cases
- Integration test cases
- End-to-end workflows

**Sáºµn SÃ ng Cho:**
- Manual testing
- Test automation
- Regression testing
- User acceptance testing (UAT)

---

**Káº¿t ThÃºc TÃ i Liá»‡u**
