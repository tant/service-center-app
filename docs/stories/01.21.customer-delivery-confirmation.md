# Story 1.21: Xác nhận Giao Hàng để Hoàn Thành Phiếu Dịch Vụ

**Epic:** [Epic 01: Workflow, Warranty, and Warehouse Management](epic-01-workflow-warranty-warehouse.md)

## Tổng Quan

Tính năng này giới thiệu một bước bắt buộc trong quy trình dịch vụ: nhân viên phải xác nhận đã bàn giao sản phẩm cho khách hàng thì phiếu dịch vụ mới được coi là **hoàn thành**.

Mục tiêu là đảm bảo mọi sản phẩm sau sửa chữa đều được ghi nhận đã trả lại cho khách hàng một cách rõ ràng, tránh thất lạc và tăng cường trách nhiệm trong khâu cuối của quy trình.

## Luồng Hoạt Động

1.  **Chuyển Trạng Thái Mới:**
    *   Sau khi một công việc (task) cuối cùng trong phiếu dịch vụ được hoàn thành, phiếu sẽ không tự động chuyển sang `Completed` (Hoàn thành) như trước.
    *   Thay vào đó, phiếu sẽ được chuyển sang một trạng thái mới: `Ready for Pickup` (Sẵn sàng bàn giao).

2.  **Giao Diện Xác Nhận Giao Hàng:**
    *   Một trang mới "Giao hàng" (`/operations/deliveries`) được thêm vào hệ thống, chỉ dành cho các vai trò như `admin`, `manager`, và `reception`.
    *   Trang này sẽ hiển thị một danh sách tất cả các phiếu dịch vụ đang ở trạng thái `Ready for Pickup`.

3.  **Hành Động Xác Nhận:**
    *   Từ danh sách, nhân viên có thể chọn một phiếu và thực hiện hành động "Xác nhận giao hàng".
    *   Khi xác nhận, hệ thống sẽ:
        *   Cập nhật trạng thái của phiếu dịch vụ từ `Ready for Pickup` thành `Completed` (Hoàn thành).
        *   Ghi lại dấu thời gian (`delivery_confirmed_at`) và người đã xác nhận (`delivery_confirmed_by_id`).
    *   Một bình luận hệ thống sẽ được tự động thêm vào phiếu để ghi nhận "Đã xác nhận giao hàng cho khách hàng".

## Thay Đổi Kỹ Thuật

*   **Database:**
    *   Thêm giá trị `ready_for_pickup` vào Enum `ticket_status`.
    *   Thêm các cột mới `delivery_confirmed_at` và `delivery_confirmed_by_id` vào bảng `service_tickets`.
*   **Backend (API):**
    *   Cập nhật mutation `confirmDelivery` để chỉ xử lý các phiếu có trạng thái `ready_for_pickup`.
    *   Cập nhật logic để chuyển trạng thái sang `completed` sau khi xác nhận.
*   **Frontend:**
    *   Thêm mục "Giao hàng" vào thanh điều hướng (sidebar).
    *   Tạo trang `/operations/deliveries` để liệt kê các phiếu chờ giao.
    *   Cập nhật modal xác nhận, loại bỏ phần chữ ký và ghi chú không còn cần thiết trong luồng mới này.

## Quyền Truy Cập

*   Chỉ các vai trò `admin`, `manager`, `reception` mới có thể truy cập trang "Giao hàng" và thực hiện xác nhận.
