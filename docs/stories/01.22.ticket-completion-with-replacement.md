# Story 01.22: Ticket Completion with Outcome & Replacement Product

**Status:** ðŸ”² Pending
**Created:** 2025-12-15
**Requirements:** FR32, FR33
**Plan:** [TICKET-COMPLETION-WITH-REPLACEMENT.md](../plans/TICKET-COMPLETION-WITH-REPLACEMENT.md)

---

## User Story

**As a** technician or manager,
**I want** to complete service tickets with a specific outcome (repaired, warranty replacement, unrepairable),
**So that** the system can track the result and automatically handle inventory movements for warranty replacements.

---

## Background

Currently, completing a ticket only changes status to `completed` and sends email notification. There is no:
- Tracking of outcome (how was the ticket resolved?)
- Selection of replacement product for warranty cases
- Automatic inventory movement for warranty replacements

This story adds outcome tracking and replacement product selection to the ticket completion flow.

---

## Acceptance Criteria

### Database (AC1-AC3)

**AC1**: Create ENUM `ticket_outcome` with values:
- `repaired` - Product was successfully repaired
- `warranty_replacement` - Product replaced from warranty stock
- `unrepairable` - Product cannot be repaired or replaced

**AC2**: Add columns to `service_tickets`:
- `outcome` (ticket_outcome, nullable)
- `replacement_product_id` (UUID, FK to physical_products, nullable)

**AC3**: Add constraint ensuring `replacement_product_id` is only set when `outcome = 'warranty_replacement'`

### Backend API (AC4-AC6)

**AC4**: Create mutation `completeTicket` with input:
```typescript
{
  ticket_id: string
  outcome: 'repaired' | 'warranty_replacement' | 'unrepairable'
  replacement_product_id?: string  // Required if outcome = warranty_replacement
  notes?: string
}
```

**AC5**: Validate replacement product:
- Must exist in `physical_products`
- Must be in `warranty_stock` virtual warehouse
- Must be same `product_id` as ticket product
- Must have `status = 'active'`

**AC6**: On successful completion with `warranty_replacement`:
- Update ticket status, outcome, replacement_product_id, completed_at
- Move replacement product: `warranty_stock` â†’ `customer_installed`
- Set `last_known_customer_id` on replacement product
- Create `stock_movement` record
- Create auto-comment with outcome details

### Query API (AC7)

**AC7**: Create query `getAvailableReplacements(ticket_id)`:
- Returns list of physical products from `warranty_stock`
- Filtered by same `product_id` as ticket
- Only `status = 'active'` products

### Frontend UI (AC8-AC10)

**AC8**: Create "Sáº£n pháº©m Ä‘á»•i tráº£" Card on ticket detail page:
- Only visible when `warranty_type = 'warranty'`
- Shows empty state if no replacement selected
- Shows replacement product details if `outcome = 'warranty_replacement'`

**AC9**: Create "HoÃ n thÃ nh phiáº¿u" Modal:
- Radio buttons for outcome selection
- Product selector (only when `warranty_replacement` selected)
- Notes textarea
- Submit button with validation

**AC10**: Update TicketActions component:
- Add "HoÃ n thÃ nh phiáº¿u" button
- Only visible for `in_progress` or `ready_for_pickup` status
- Opens CompleteTicketModal on click

---

## Technical Notes

### Database Migration

```sql
-- Add ENUM
CREATE TYPE public.ticket_outcome AS ENUM (
  'repaired', 'warranty_replacement', 'unrepairable'
);

-- Add columns
ALTER TABLE public.service_tickets
ADD COLUMN outcome public.ticket_outcome,
ADD COLUMN replacement_product_id UUID REFERENCES public.physical_products(id);

-- Add constraint
ALTER TABLE public.service_tickets
ADD CONSTRAINT chk_replacement_requires_outcome CHECK (
  (outcome = 'warranty_replacement' AND replacement_product_id IS NOT NULL) OR
  (outcome != 'warranty_replacement' AND replacement_product_id IS NULL) OR
  (outcome IS NULL)
);
```

### Files to Create/Modify

**New Files:**
- `src/components/ticket-replacement-card.tsx`
- `src/components/modals/complete-ticket-modal.tsx`

**Modified Files:**
- `src/server/routers/tickets.ts` - Add mutations/queries
- `src/app/(auth)/operations/tickets/[id]/page.tsx` - Add replacement card
- `src/components/ticket-actions.tsx` - Add complete button

---

## Integration Verification

- **IV1**: Existing `updateTicketStatus` mutation continues to work for simple status changes
- **IV2**: Tickets completed before this feature (outcome = NULL) display correctly
- **IV3**: Warranty stock decreases when replacement is issued
- **IV4**: `customer_installed` increases when replacement is issued
- **IV5**: Audit trail shows outcome in ticket comments

---

## Out of Scope

- Automatic inbound transfer when creating ticket (Luá»“ng 1 in AUTO-TRANSFER doc)
- Handling of old product (move to rma_staging) - future enhancement
- Auto-generating stock_transfer documents - using direct warehouse update for simplicity

---

## Dependencies

- Story 01.07 (Physical Product Master Data) - physical_products table
- Story 01.06 (Warehouse Hierarchy) - virtual warehouses including warranty_stock
- Story 01.08 (Stock Movements) - stock_movements table

---

## Estimated Effort

| Phase | Effort |
|-------|--------|
| Database migration | 1-2 hours |
| Backend API | 2-3 hours |
| Frontend UI | 2-3 hours |
| Testing | 1-2 hours |
| **Total** | **6-10 hours** |

---

## Test Cases

### Happy Path
1. Complete ticket with `outcome = 'repaired'` â†’ ticket completed, no inventory change
2. Complete ticket with `outcome = 'warranty_replacement'` + valid product â†’ ticket completed, inventory updated
3. Complete ticket with `outcome = 'unrepairable'` â†’ ticket completed, no inventory change

### Validation Errors
4. Missing `replacement_product_id` when `outcome = 'warranty_replacement'` â†’ error
5. Replacement product not in `warranty_stock` â†’ error
6. Replacement product different `product_id` â†’ error
7. Complete ticket from invalid status (`pending`, `cancelled`) â†’ error

### UI
8. Replacement card hidden for non-warranty tickets
9. Replacement card shows empty state before completion
10. Replacement card shows product details after warranty_replacement completion
11. Modal shows product selector only for warranty_replacement outcome
12. Modal validates required replacement product before submit
